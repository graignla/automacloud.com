<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns:st1="urn:schemas-microsoft-com:office:smarttags" xmlns="http://www.w3.org/TR/REC-html40"><head>


<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta http-equiv="pragma" content="no-cache">
<meta name="ProgId" content="Word.Document">
<meta name="Generator" content="Microsoft Word 11">
<meta name="Originator" content="Microsoft Word 11">
<link rel="File-List" href="scripts_fichiers/filelist.xml"><title>scripts</title>

<o:smarttagtype namespaceuri="urn:schemas-microsoft-com:office:smarttags" name="PersonName"></o:smarttagtype><!--[if gte mso 9]><xml> <o:DocumentProperties> <o:Author>Utilisateur Windows</o:Author> <o:LastAuthor>Utilisateur Windows</o:LastAuthor> <o:Revision>2</o:Revision> <o:TotalTime>3</o:TotalTime> <o:Created>2008-02-14T15:04:00Z</o:Created> <o:LastSaved>2008-02-14T15:07:00Z</o:LastSaved> <o:Pages>1</o:Pages> <o:Words>12137</o:Words> <o:Characters>66757</o:Characters> <o:Company>lolo</o:Company> <o:Lines>556</o:Lines> <o:Paragraphs>157</o:Paragraphs> <o:CharactersWithSpaces>78737</o:CharactersWithSpaces> <o:Version>11.5606</o:Version> </o:DocumentProperties> </xml><![endif]--><!--[if gte mso 9]><xml> <w:WordDocument> <w:HideSpellingErrors/> <w:HyphenationZone>21</w:HyphenationZone> <w:ValidateAgainstSchemas/> <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid> <w:IgnoreMixedContent>false</w:IgnoreMixedContent> <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText> <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel> </w:WordDocument> </xml><![endif]--><!--[if gte mso 9]><xml> <w:LatentStyles DefLockedState="false" LatentStyleCount="156"> </w:LatentStyles> </xml><![endif]--><!--[if !mso]><object classid="clsid:38481807-CA0E-42D2-BF39-B33AF135CC4D" id=ieooui></object> <style> st1\:*{behavior:url(#ieooui) } </style> <![endif]-->
<style>
<!--

/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
{mso-style-parent:"";
margin:0cm;
margin-bottom:.0001pt;
mso-pagination:widow-orphan;
font-size:12.0pt;
font-family:"Times New Roman";
mso-fareast-font-family:"Times New Roman";
color:black;}
a:link, span.MsoHyperlink
{color:#0000EE;
text-decoration:underline;
text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
{color:#551A8B;
text-decoration:underline;
text-underline:single;}
p
{font-size:12.0pt;
font-family:"Times New Roman";
mso-fareast-font-family:"Times New Roman";
color:black;}
pre
{margin-top:0cm;
margin-bottom:0cm;
margin-bottom:.0001pt;
font-size:10.0pt;
font-family:"Courier New";
mso-fareast-font-family:"Times New Roman";
color:black;}
@page Section1
{size:595.3pt 841.9pt;
margin:70.85pt 70.85pt 70.85pt 70.85pt;
mso-header-margin:35.4pt;
mso-footer-margin:35.4pt;
mso-paper-source:0;}
div.Section1
{page:Section1;}
-->
</style><!--[if gte mso 10]> <style> /* Style Definitions */ table.MsoNormalTable {mso-style-name:"Tableau Normal"; mso-tstyle-rowband-size:0; mso-tstyle-colband-size:0; mso-style-noshow:yes; mso-style-parent:""; mso-padding-alt:0cm 5.4pt 0cm 5.4pt; mso-para-margin:0cm; mso-para-margin-bottom:.0001pt; mso-pagination:widow-orphan; font-size:10.0pt; font-family:"Times New Roman"; mso-ansi-language:#0400; mso-fareast-language:#0400; mso-bidi-language:#0400;} </style> <![endif]-->
<meta name="Author" content="lgra0056@lsurf.fr"><!--[if gte mso 9]><xml> <o:shapedefaults v:ext="edit" spidmax="2050"/> </xml><![endif]--><!--[if gte mso 9]><xml> <o:shapelayout v:ext="edit"> <o:idmap v:ext="edit" data="1"/> </o:shapelayout></xml><![endif]--></head>
<body style="background-color: rgb(90, 132, 146);" alink="#ff0000" lang="FR" link="#0000ee" vlink="#551a8b">
<div style="font-family: Courier New;" class="Section1">
<div style="text-align: left;"></div>
<table class="MsoNormalTable" style="width: 1261px;" border="1" cellpadding="0">
<tbody>
<tr style="height: 0.75pt;">
<td style="padding: 11.25pt; background: black none repeat scroll 0% 50%; -moz-background-clip: initial; -moz-background-origin: initial; -moz-background-inline-policy: initial; width: 1210px; height: 0.75pt;">
<p style="margin: 0cm 0cm 0.0001pt;"><a href="index.html">Retour à l'accueil</a></p>
<p style="margin: 0cm 0cm 0.0001pt; text-align: left;"> </p>
<p style="margin: 0cm 0cm 7.6pt; text-align: left;"><b><i><span style="background: rgb(66, 66, 115) none repeat scroll 0% 50%; -moz-background-clip: initial; -moz-background-origin: initial; -moz-background-inline-policy: initial; font-size: 24pt; color: rgb(159, 184, 156);">SHELL-SCRIPT
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; Certains de mes scripts&nbsp;</span></i></b></p>
</td>
</tr>





    <tr style="color: rgb(102, 102, 102);">
      <td style="vertical-align: top; background-color: rgb(51, 204, 255);">#!/bin/sh<br>
# Autor : Laurent Graignic : l.graignic@oberthur.com<br>
# Create JAD files in WWW_DIR directory for each jad file contained in the MIDLET_DIR sub directory of WWW_DIR.<br>
# The created JAD files are modifyed to supply URL of the other files located in the original JAD file directorys.<br>
# WWW_DIR can be specified as an argument. Default values are :<br>
      <br>
# HELP : -h or --help message<br>
[ "$1" = "-h" -o "$1" = "--help" ] &amp;&amp; { head -5 $0 ; egrep
"DEFAULT=|FONT_SIZE=" $0|tail -1|sed -e "s/^/# /" -e
"s/DEFAULT/WWW_DIR/" ; echo "This Help is avilable using -h or --help"
; exit ; }<br>
      <br>
# Because may be launched by CROND<br>
AWK=/bin/awk ; FIND=/usr/bin/find ; SED=/bin/sed ; ECHO=/bin/echo ;
RM=/bin/rm ; LN=/bin/ln ; TEST=/usr/bin/test ; BASENAME=/bin/basename ;
GREP=/bin/grep ; CAT=/bin/cat ; DIRNAME=/usr/bin/dirname ; LS=/bin/ls ;
SORT=/bin/sort ; CUT=/bin/cut ; UNIQ=/usr/bin/uniq<br>
      <br>
MY_DIR=$(cd $(dirname $0) ; pwd )<br>
NEW_MID_DIR=$MY_DIR/NEW_MID_DIR<br>
mkdir -p $NEW_MID_DIR<br>
# TIME &amp; Process Stamp used for logs<br>
REF="$(date "+%F at %H:%M") - $($BASENAME $0):"<br>
export REF2=$(date '+%F_at_%Hh%M'_PID$$)<br>
OLD_MID_DIR=$MY_DIR/OLD_MID_DIR/$REF2<br>
mkdir -p $OLD_MID_DIR<br>
      <br>
# Default Directory:<br>
DEFAULT=/home/apache/apache2/htdocs<br>
      <br>
# Just to make nice output report<br>
DOMAIN_URL=https://santander.oberthur.com/<br>
      <br>
# WWW directory (May be given as an arument)<br>
WWW_DIR=${1:-$DEFAULT}<br>
# Must contain Midlet package sub dir<br>
      <br>
# Check that WWW-REP is defined as an absolute path or exit<br>
$ECHO $WWW_DIR|$AWK -v REF="$REF" '$0!~/^[/]/ {print REF,"\""$0"\" is
Not an absolute path\n"}'|$GREP . &gt;&amp;2 &amp;&amp;&nbsp; exit 1<br>
      <br>
# Remove possible "/" at the end of the path of WWW-REP<br>
WWW_DIR=$($ECHO "$WWW_DIR"|$SED "s%/$%%g")<br>
      <br>
# Location of the&nbsp; midlet's file sets<br>
export MIDLET_DIR_NAME=midlets<br>
export MIDLET_DIR=$WWW_DIR/$MIDLET_DIR_NAME<br>
      <br>
# Cmdes "SED" : Definition d'utilisation des noms de dossier pour la creation des noms des fichier JAD<br>
echo "s/ /.jad /g<br>
s/$/.jad/<br>
s/ot_SAN//g<br>
s/_//g" &gt; $MY_DIR/.rename.sed<br>
      <br>
      <br>
# Check for a valid directory structure, if not, notify and exit<br>
[ -d $WWW_DIR ] || { $ECHO $REF \"$WWW_DIR\" is not a directory, please
specify a valid directory or try \"$0\" \without argument, default
$DEFAULT will be used &gt;&amp;2; exit 1; }<br>
[ -d $MIDLET_DIR ] || { $ECHO $REF \"$MIDLET_DIR\" directory must exist to run this script &gt;&amp;2; exit 1; }<br>
      <br>
      <br>
(<br>
# new midlet listing<br>
cd $NEW_MID_DIR<br>
LISTE2=$(find * -type f -name "*debug" -o -name "*cod" -o -name "*jar"
-o -name "*jad" 2&gt;/dev/null|awk -F"/" '{print $1}'|uniq)<br>
      <br>
# Transfering midlet<br>
cd $MIDLET_DIR<br>
mv $LISTE2 $OLD_MID_DIR 2&gt;/dev/null||{ rmdir $OLD_MID_DIR &amp;&amp; echo "$REF2 : No middlets are to be backed up" ; }<br>
cd $NEW_MID_DIR<br>
mv $LISTE2 $MIDLET_DIR 2&gt;/dev/null &amp;&amp; echo $LISTE2|tr '|' ' '|sed "s/^/Suplyed middlets: /"<br>
cd $MIDLET_DIR<br>
      <br>
# Current midlet listing<br>
LISTE=$(find * -type f -name "*debug" -o -name "*cod" -o -name "*jar" -o -name "*jad"|awk -F"/" '{print $1}'|uniq)<br>
      <br>
# Check for missing jad file to be created again<br>
&gt;$MY_DIR/.DIFF<br>
for REP_NAME in $LISTE <br>
do<br>
&nbsp;&nbsp;&nbsp; FILE=$(echo $REP_NAME|sed -f $MY_DIR/.rename.sed|sed -e "s%^%$WWW_DIR/%" -e "s% % $WWW_DIR/%g")<br>
&nbsp;&nbsp;&nbsp; test -f $FILE || echo $REP_NAME|sed
"s%^%$MIDLET_DIR/%"|tee -a $MY_DIR/.DIFF|sed "s%$% : Remaking&nbsp;
$FILE%"<br>
done<br>
      <br>
# Check for extra files to be deleted in the midlet dir<br>
FILTRE=$(echo $LISTE|tr ' ' '|'|sed "s/$//")<br>
ls|egrep -v "$FILTRE"|while read DELFILE ; do echo $REF2 : $DELFILE deleted|tee -a $MY_DIR/changes.log ; rm -r $DELFILE ; done<br>
      <br>
# Check for extra files to be deleted in the WWW_DIR dir<br>
FILTRE2="$(echo $LISTE|sed -f $MY_DIR/.rename.sed|sed -e "s/ /$|/g" -e "s/$//")|README.txt$|$MIDLET_DIR_NAME$"<br>
ls -ld $WWW_DIR/*|egrep -v "$FILTRE2"|sed "s/$/ ......DELETED/"<br>
ls -d $WWW_DIR/*|egrep -v "$FILTRE2"|while read LINE ; do rm -r "$LINE"
&amp;&amp; echo $REF $(basename $LINE) has been deleted &gt;&gt;
$MY_DIR/changes.log ; done<br>
      <br>
# Check for archive under midlet DIR, decompress it in midlet DIR and supress archives.<br>
find */*/* -type f -name "*debug" -o -name "*cod" -o -name "*jar" -o
-name "*jad" 2&gt;/dev/null |awk -F"/" '{print "mv "$0" "$1}'|sh<br>
find */*&nbsp; -prune -type d -exec rm -rf {} \;<br>
find . -type f -name "*.cod" -exec file {} \;|grep ": Zip archive data,
at least v1.0 to extract$"|sed "s/: Zip archive data, at least v1.0 to
extract$//"|awk -F"/" '{print "(cd $(dirname "$0") ; unzip -o
"$NF")"}'|sh<br>
      <br>
# creation of a&nbsp; signature for each midlet<br>
for I in $LISTE; do (echo -n "$I."; find $I -type f|xargs
md5sum|md5sum|sed "s/[ -]//g") ; done &gt;
$MY_DIR/packageSignature/$REF2<br>
      <br>
# Liste des midlets ayant des signatures differentes de la precedente installation<br>
DIFF=$(diff $(ls -rt $MY_DIR/packageSignature/*|tail -2)|egrep "^&gt;|^&lt;"|awk '{print $2}'|cut -f1 -d"."|sort -u)<br>
      <br>
# Si aucune midlet n'a change, supprimer le fichier des signatures,
sinon referencer les nouvelles midlet en vu de creer un nouveau fichier
JAD<br>
#if echo $DIFF|grep -q .<br>
if [ -n "$DIFF" ]<br>
then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo&nbsp; $REF2 : $DIFF has changed |tee -a $MY_DIR/changes.log<br>
&nbsp;&nbsp;&nbsp; echo $DIFF|tr ' ' '\012'|sed "s%^%$MIDLET_DIR/%" &gt;&gt; $MY_DIR/.DIFF<br>
else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo&nbsp; $REF2 : No change detected|tee -a $MY_DIR/changes.log<br>
&nbsp;&nbsp;&nbsp; rm $MY_DIR/packageSignature/$REF2<br>
fi<br>
)<br>
      <br>
      <br>
# If required, create needed version of jad file according to the changes which have been detected<br>
grep -q . $MY_DIR/.DIFF &amp;&amp; {<br>
$FIND $(cat $MY_DIR/.DIFF|sort -u) -type f -iname "*.jad" 2&gt;/dev/null|(while read JAD_FILE<br>
do<br>
&nbsp;&nbsp;&nbsp; #set -x<br>
&nbsp;&nbsp;&nbsp; JAD_WWW_PATH=$(echo $JAD_FILE|$SED
"s%$WWW_DIR/%%")&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; # ex :
midlets/Visa_Classic/Card_Visa_Classic.jad<br>
&nbsp;&nbsp;&nbsp; DIR_REL_PATH=$(dirname
$JAD_WWW_PATH)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; # ex :
midlets/Visa_Classic <br>
&nbsp;&nbsp;&nbsp; NEW_JAD_NAME=$(echo $DIR_REL_PATH|awk -F/ '{print
$NF}'|$SED -f $MY_DIR/.rename.sed)&nbsp; # ex : Visa_Classic.jad<br>
&nbsp;&nbsp;&nbsp; NEW_JAD_FILE=$WWW_DIR/$NEW_JAD_NAME # ex : /home/apache/apache2/htdocs/Visa_Classic.jad<br>
&nbsp;&nbsp;&nbsp; $CAT $JAD_FILE|$SED "s%^\(.*-URL.*: \)\(.*\)$%\1$DIR_REL_PATH/\2%" &gt; $NEW_JAD_FILE<br>
&nbsp;&nbsp;&nbsp; ## Check that all URL have been changed, else remove created JAR.<br>
&nbsp;&nbsp;&nbsp; $CAT $JAD_FILE $NEW_JAD_FILE|$GREP URL|sed
"s%$DIR_REL_PATH/%%"|$SORT|$UNIQ -c|$AWK '$1 == 1'|$GREP -q .
&amp;&amp; {<br>
&nbsp;&nbsp;&nbsp; $RM $NEW_JAD_FILE ; echo "$REF Error - $NEW_JAD_FILE not created" &gt;&amp;2 ; }<br>
&nbsp;&nbsp;&nbsp; ## Check that all file path exists in the new JAD files<br>
&nbsp;&nbsp;&nbsp; $GREP URL $NEW_JAD_FILE|$CUT -f2 -d:|$SED "s%^ %$WWW_DIR/%"|while read LINE<br>
&nbsp;&nbsp;&nbsp; do<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; test -f "$LINE" || { echo $REF
$LINE: Missing file - $NEW_JAD_NAME, not supplyed|tee -a
$MY_DIR/changes.log &gt;&amp;2 ; rm $NEW_JAD_FILE ; break ; }<br>
&nbsp;&nbsp;&nbsp; done<br>
done<br>
)<br>
}<br>
echo $REF LAST UPDATES :<br>
(cd $WWW_DIR ; ls -l *.jad)|awk -v DOMAINE=$DOMAIN_URL '{print $6,$7,$8,DOMAINE$9}'&gt; $WWW_DIR/README.txt<br>
cat $WWW_DIR/README.txt<br>
echo<br>
      <br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">
      <div style="text-align: center;"><span style="background-color: white;"><br>
      <span style="background-color: rgb(51, 51, 51); color: white;">&nbsp;Ce script a été utilisé sur 800 serveurs avec succès chez CALYON CHEUVREUX </span><br>
      <br>
      </span></div>
#!/bin/ksh<br>
# Agent de verification de fichiers de configuration critiques (multiplateformes)<br>
# Permet de détecter des configuration non standard pour les corriger<br>
# ou de les assimiler comme standart pour la population de machines concernées<br>
#set -x<br>
#exec 2&gt; /dev/null<br>
      <br>
      <br>
#<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Atteindre la conf : (Aller a -&gt; -MARK-)<br>
#<br>
################### FORMAT DU&nbsp; FICHIER DE CONFIGURATION GENERAL #####################<br>
##-
CHAMPS_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
CHAMPS_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
CHAMPS_3<br>
##- Categorie/nom_de_machine&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Fichier a verifier&nbsp;&nbsp;&nbsp;&nbsp; valeurMD5 a respecter<br>
#####################################################################################<br>
##- NOTE : De ce fichier, la machine va extraire les lignes la concernant<br>
##- <br>
##- La machine va determiner sa categorie (pays+OS+YP_STATUS) ainsi que le ou les noms auxquels elle doit s'assimiler<br>
##- Elle va ainsi pouvoir extraire du fichier de configuration les lignes la concernant.<br>
##- Si il y a plusieurs enregistrements pour un meme fichier, l'information retenue sera dans l'ordre :<br>
##<br>
##&nbsp; 1) l'enregistrements relatifs au nom complet<br>
##&nbsp; 2) l'enregistrements relatif au nom generique<br>
##&nbsp; 3) l'enregistrements relatif a la categorie<br>
##<br>
##- Si, pour une machine, plusieurs enregistrements d'une meme categorie concernent le meme fichier,<br>
##- Toutes les valeurs cibles md5 seront testees et si l'une d'entre elles match, le test sera OK<br>
##- OPTIONS : -v Affiche le resutat des test OK et KO, avec la regle utilisee et le nom de la machine<br>
##&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; : -V Affichage de -v avec en
plus des indications sur les fichier inexistants, des alertes<br>
##&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sur des redondances de regles se rapportant a un fichier a traiter, ou
l'bscence de<br>
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; verifications a mener. <br>
      <br>
##- Emplacement de depot temporaire des fichiers de travail<br>
WDIR=/tmp/$(basename $0)_dir&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; # le work directory porte le nom du script<br>
NET_HOSTNAME=$(uname -n) &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; # pour que les fichiers portent le nom de la machine<br>
mkdir -p $WDIR 2&gt; /dev/null&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; # creation du work dir<br>
CONFIG_GEN=$WDIR/config.all<br>
CONFIG_CATEGORIE=$WDIR/categorie<br>
CONFIG_SPECIF=$WDIR/specifique<br>
CONFIG_GENERIQUE=$WDIR/generique<br>
##- FICHIERS DE RAPPORTS<br>
RAPPORT_OK=$WDIR/rapport.ok<br>
RAPPORT_KO=$WDIR/rapport.ko<br>
MESSAGE=$WDIR/message<br>
OPT=$1<br>
rm -f $WDIR/*<br>
      <br>
##- Conservation de N copies de sauvegardes DIFFERENTES du script a son emplacement d'origine<br>
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
~~~~~~~~~~~<br>
N=5<br>
DATE=$(date +%Y%m%d_%HH%M)<br>
DIR=`(cd $(dirname $0);pwd)`<br>
BASE=`basename $0`<br>
CESCRIPT=$DIR/$BASE<br>
NBCOPIES=$(find $DIR -name "$BASE.*" -type f|wc -l|awk '{print $1}')<br>
HEAD=`echo $(expr $N - $NBCOPIES )|sed "s/^[^-].*/-0/"`<br>
[ $NBCOPIES -lt 1 ] &amp;&amp; cp $CESCRIPT $CESCRIPT.$DATE<br>
ARGS=$(ls -1rt $CESCRIPT $CESCRIPT.*|tail -2|head -1)<br>
cmp -s $CESCRIPT $ARGS || cp $CESCRIPT $CESCRIPT.$DATE &amp;&amp; touch $CESCRIPT<br>
find $DIR -name "$BASE*" -type f|xargs ls -t 2&gt;/dev/null|tail $HEAD|xargs rm -f 2&gt;/dev/null<br>
      <br>
      <br>
##- OS de la machine executant le script<br>
OS=$(uname)<br>
echo $OS|egrep "Linux|SunOS" &gt; /dev/null || signalementERRSTOP OSINCONNU<br>
      <br>
##- Le script devant tourner sur Linux ou Solaris,<br>
#&nbsp;&nbsp; Variabilisation des commandes "md5sum" "grep" et "egrep" en fonction de l'OS<br>
      <br>
#&nbsp; Pour Linux<br>
#------------<br>
GREP=grep<br>
EGREP=egrep<br>
MD5SUM=/disk01/misc/bin/md5<br>
AWK=awk<br>
#&nbsp; variabilisation de la variable LIST_PAYS <br>
##- LIST_PAYS : Constitution de la liste des pays en 2 lettres + "bk" (Site de backup)<br>
##- Exemple: am|at|du|fr|is|lo|ma|mi|ny|pa|st|vi|zu|bk<br>
AJOUT_PAYS="bk"<br>
LIST_PAYS=$(ypcat -k ypservers -h panis001 2&gt;/dev/null|cut -c1,2|sort -u|tr -s '\012' ' ')<br>
LIST_PAYS=${LIST_PAYS:-am at du fr is lo ma mi ny pa st vi zu}<br>
LIST_PAYS=$(echo $LIST_PAYS $AJOUT_PAYS | tr -s " " "|")<br>
      <br>
#&nbsp; Pour Solaris<br>
#-------------<br>
[ "$OS" = "SunOS" ] &amp;&amp; {<br>
&nbsp;&nbsp;&nbsp; GREP=/usr/xpg4/bin/grep<br>
&nbsp;&nbsp;&nbsp; EGREP=/usr/xpg4/bin/egrep<br>
&nbsp;&nbsp;&nbsp; AWK=/usr/xpg4/bin/awk<br>
&nbsp;&nbsp;&nbsp; LISTE_PAYS="am|at|du|fr|is|lo|ma|mi|ny|pa|st|vi|zu|bk"&nbsp; # A mettre a jour en cas de nouveau pays<br>
}<br>
[ "$1" = "--help" ] &amp;&amp; { $AWK 'NR &gt; 5 &amp;&amp; NR &lt; 30 {print}' $0 ; exit ;} <br>
      <br>
##- FICHIER DE CONFIGURATION GENERAL : Categories du plus general au plus specifique<br>
## &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; et du moins
prioritaire au plus prioritaire <br>
##------------------------------------------------------------------------<br>
##- 1ere section : CATEGORIES<br>
##- 2eme section : NOMS GENERIQUES<br>
##- 3eme section : NOMS COMPLETS<br>
##- Modifier ci-dessous le FICHIER DE CONFIGURATION GENERAL <br>
##&nbsp; (Enregistrements valides sur 3 champs, commentaires possibles<br>
## 1er champs=De 1 a 13 car alfanum+(-)(_)&nbsp; ; 2eme
champs=/...&nbsp;&nbsp; ; 3eme
champs=(MD5sum)=f070466b622bf16a869ca69dad27ebe9<br>
&nbsp;<br>
cat &lt;&lt; EOF|sed "s/#.*//"|$AWK '{print $1,$2,$3}'|$GREP "^[^ ]\{1,13\} \/[^ ][^ ]* [0-9a-f]\{32\}" &gt; $CONFIG_GEN <br>
#####################################################################################<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
FICHIER DE CONFIGURATION
GENERAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#------------------------------------------------------------------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#- 1ere section :
CATEGORIES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#- 2eme section : NOMS
GENERIQUES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#- 3eme section : NOMS
COMPLETS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
      <br>
##################### CATEGORIES #######################<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
SECTION 1<br>
      <br>
#&nbsp;&nbsp;&nbsp;&nbsp; Exemple:<br>
# amLinuxYPSERV /rep_dest/fic_a_verifier<br>
########################################################<br>
frLinuxYPSERV /etc/ntp.conf 7b1296a5d441daab254d9ef37dc4d884 # A decommenter<br>
frLinuxYPBIND /etc/ntp.conf b67e502cab84df90df45be91c9810a4a # A decommenter<br>
paLinuxYPBIND /etc/ntp.conf 52b1e70f7a93dbaefab1d8cf30a9ad62 # A decommenter<br>
paLinuxYPBIND /etc/ntp.conf 05f496b0b4c1a08262fba1ab62be78a7 # A decommenter<br>
paLinuxYPBIND /etc/ntp.conf 8be5674bd875cffe5c17b932ada3e300 # 4 machines dont padev831<br>
paLinuxYPBIND /etc/modprobe.conf 1ba84afdd1175355db151fb5469e5cb8 # Bon, mais a modifier plus tard<br>
paLinuxYPBIND /etc/modprobe.conf ae415b999f9fa3bb599c65abe8e34dcd # lagra<br>
paLinuxYPBIND /etc/modprobe.conf 004e5b0598581eaa1979485ef349b0ef # OK<br>
paLinuxYPBIND /etc/modprobe.conf ea2d1adaa3e19acd015d0467ab1a791c # OK<br>
paLinuxYPBIND /etc/modprobe.conf bc1f4e762e319039878ca73df6776565 # OK<br>
paLinuxAUTRES /etc/modprobe.conf bc1f4e762e319039878ca73df6776565 # 2 machines<br>
paLinuxYPBIND /etc/modprobe.conf c57020b7edf545f810445afa49cc0b3e # OK<br>
paLinuxYPBIND /etc/modprobe.conf 7c836a8e9c09cde1188c9229433bed35 # 2 machines<br>
paLinuxYPBIND /etc/modprobe.conf 9629552beed948ff67af45961af772de<br>
paLinuxYPBIND /etc/modprobe.conf 779cc2c23a88b3eb2a94e0d500529f1b # 2 machines<br>
paLinuxYPBIND /etc/modprobe.conf 59c5a1d4add3b3cf45d1b85ae0c54071 # 2 machines<br>
paLinuxYPBIND /etc/modprobe.conf 559b20d86efb575497c58ac9ae11123c # 2 machines<br>
paLinuxYPBIND /etc/modprobe.conf 14057c7524c0820ea31f103e17878fa7<br>
paLinuxYPSERV /etc/modprobe.conf 14057c7524c0820ea31f103e17878fa7<br>
paLinuxYPSERV /etc/modprobe.conf 9629552beed948ff67af45961af772de<br>
paLinuxYPSERV /etc/modprobe.conf 13e275016f2b107b0893785e4cfd6a5d # Bon, mais a modifier plus tard<br>
paLinuxYPBIND /etc/modprobe.conf 13e275016f2b107b0893785e4cfd6a5d # Bon, mais a modifier plus tard<br>
paLinuxYPSERV /etc/modprobe.conf 58a04aa40a53118d31c5b95cb58e4e6f # Bon, mais a modifier plus tard<br>
paLinuxYPBIND /etc/modprobe.conf 58a04aa40a53118d31c5b95cb58e4e6f # Bon, mais a modifier plus tard<br>
      <br>
paLinuxYPSERV /etc/modprobe.conf 6cf382905fa8ce0eba7fc91db80a3f47 <br>
paLinuxYPBIND /etc/modprobe.conf 6cf382905fa8ce0eba7fc91db80a3f47<br>
paLinuxAUTRES /etc/modprobe.conf ae415b999f9fa3bb599c65abe8e34dcd<br>
paLinuxAUTRES /etc/modprobe.conf 13e275016f2b107b0893785e4cfd6a5d #simple concerne 5 machines<br>
paLinuxAUTRES /etc/modprobe.conf 1ba84afdd1175355db151fb5469e5cb8 #usb controler a retirer<br>
paLinuxAUTRES /etc/modprobe.conf e8a3bc2260a9b5922b7c2e74c4ac0417 # correction sur pagln003 et pagln004<br>
paLinuxAUTRES /etc/modprobe.conf 1dad24d8cedbd78e67334b5e27275708 # correction sur paemg007 pamqs002<br>
paLinuxAUTRES /etc/modprobe.conf 9629552beed948ff67af45961af772de # correction sur paswx098 paswx099<br>
paLinuxAUTRES /etc/modprobe.conf 6cf382905fa8ce0eba7fc91db80a3f47 #OK<br>
paLinuxAUTRES /etc/modprobe.conf 58a04aa40a53118d31c5b95cb58e4e6f #OK usb controleur a virer paemg003 pamqs003<br>
paLinuxYPBIND /etc/modprobe.conf c5e432f9f6053f9e94b92bb18509a854 #OK mais complex, semble OK pasyb006 et pasyb002<br>
paLinuxYPBIND /etc/modprobe.conf 4ae3856376559ff318411b1a1954aee6 # 1 machine(s) dontpaexp822<br>
      <br>
      <br>
#-MARK-<br>
################# NOMS GENERIQUES DE MACHINES ##########<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
SECTION 2<br>
#&nbsp;&nbsp;&nbsp;&nbsp; Exemple:<br>
#&nbsp; /regexp/ /rep_dest/fic_a_verifier 8bddd9a9527a96d89501eaf8bceba4fe<br>
########################################################<br>
/pasyb.*/ /etc/nsswitch.conf cb058a749e7cadf28758cb59d0a08b61 #md5sum de pasyb055<br>
/..*/ /disk01/middle/.ssh/id_dsa.pub cb058a749e7cadf28758cb59d0a08b61 #test ponctuel<br>
#-MARK-<br>
############## NOMS SPECIFIQUES DE MACHINES ############<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
SECTION 3 <br>
#&nbsp;&nbsp;&nbsp;&nbsp; Exemple:<br>
# pavmw001 /rep_dest/fic_a_verifier 6a3f9b0a1a006820a7d3140652fae2bc<br>
########################################################<br>
frbkp001 /etc/ntp.conf b67e502cab84df90df45be91c9810a4a # exeption a frLinuxYPBIND<br>
paemg022 /etc/modprobe.conf 14057c7524c0820ea31f103e17878fa7 # <br>
parsb041 /etc/modprobe.conf e8a3bc2260a9b5922b7c2e74c4ac0417 # Modifie (bond) Mar 12 18:41<br>
pahqs003 /etc/modprobe.conf c57020b7edf545f810445afa49cc0b3e #OK usb controleur a virer<br>
pahmg003 /etc/modprobe.conf caa7f88226b9f2173bfd2275021ca971 #OK usb controleur a virer<br>
pasyb009 /etc/modprobe.conf 0e95fd86721a7f81a623c96652b384c0 #OK<br>
pasyb045 /etc/modprobe.conf 0fa526ac9811e391142274f6996e282c #OK usb controleur a virer<br>
paexp033 /etc/modprobe.conf 22c8d03da9f1f99f396ff0e1a9209de1 #OK mais complex, semble OK<br>
pasyb003 /etc/modprobe.conf 27ea2a56a4a04b0c456c46aacdbcf031 #OK mais complex, semble OK<br>
pabkp012 /etc/modprobe.conf 2b3dfdc92db264b788d4298c0457d237 #OK mais complex, semble OK<br>
paulk004 /etc/modprobe.conf 383543fda5be7be4cb8f40426e31211a #OK usb controleur a virer<br>
pasyb073 /etc/modprobe.conf 3d76c66267d7d5608e535cb2503360e8 #OK<br>
pahol001 /etc/modprobe.conf 5d1225d4788a9a422dff1a24e88371f9 #OK<br>
pasyb092 /etc/modprobe.conf 9397abd4e7101e11603f0d14849568a9 #OK mais complex, semble OK<br>
pasyb093 /etc/modprobe.conf a71249187ae689d45f42beaad94259a6 #OK mais complex, semble OK<br>
pacod002 /etc/modprobe.conf ab403ed1f60649fefdef1781d9337402 #OK mais complex, semble OK<br>
pasyb054 /etc/modprobe.conf c242db581c28d5ced6c10a19d3ad01de #OK usb controleur a virer<br>
padac001 /etc/modprobe.conf d6ac2e81846799d45fae3522e8046f5d #OK usb controleur a virer<br>
pasyb046 /etc/modprobe.conf e9553df1124a1415e3d2181c5657d39a #OK mais complex, semble OK pasyb046<br>
      <br>
      <br>
#-MARK-<br>
EOF<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#####################################################################################<br>
sort $CONFIG_GEN|uniq -c|awk '$1 &gt; 1 {print "Definitions des regles
: ATTENTION !!"$1" occurences de : "$2,$3,$4}'|sed "s/!!/!!\n/"<br>
      <br>
      <br>
Nettoyage()<br>
{<br>
#set -x<br>
EXEPT="$1rapport.Test_KO$|rapport.no_exist$|message\..*$"<br>
find $WDIR -type f |$EGREP -v $EXEPT|xargs rm -f<br>
find $WDIR -type f -ls|$AWK '$7 == 0 {print $11}'|xargs rm -f<br>
}<br>
      <br>
Affichage()<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for F in $WDIR/*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo $NET_HOSTNAME : $(echo $F|sed "s@^.*/..*\.\([^/][^/]*\)@\1@")<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cat $F|sort -u<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; done 2&gt; /dev/null<br>
}<br>
      <br>
##- Fonction speciales en cas de valeurs imprevues ou de l'option -v<br>
signalementERRSTOP()<br>
{<br>
#set -x<br>
case $1 in<br>
&nbsp;&nbsp;&nbsp; OSINCONNU)<br>
&nbsp;&nbsp;&nbsp; echo $NET_HOSTNAME:OSINCONNU &gt;&gt; $MESSAGE.Alerte<br>
&nbsp;&nbsp;&nbsp; Nettoyage<br>
&nbsp;&nbsp;&nbsp; [ "$OPT" = "-V" ] &amp;&amp; Affichage<br>
&nbsp;&nbsp;&nbsp; exit 1<br>
&nbsp;&nbsp;&nbsp; ;;<br>
&nbsp;&nbsp;&nbsp; PAYSINCONNU)<br>
&nbsp;&nbsp;&nbsp; echo $NET_HOSTNAME:PAYSINCONNU &gt;&gt; $MESSAGE.Alerte<br>
&nbsp;&nbsp;&nbsp; Nettoyage<br>
&nbsp;&nbsp;&nbsp; [ "$OPT" = "-V" ] &amp;&amp; Affichage<br>
&nbsp;&nbsp;&nbsp; exit 2<br>
&nbsp;&nbsp;&nbsp; ;;<br>
&nbsp;&nbsp;&nbsp; MD5NOTPRESENT)<br>
&nbsp;&nbsp;&nbsp; echo $NET_HOSTNAME:MD5sum NOT PRESENT &gt;&gt; $MESSAGE.Alerte<br>
&nbsp;&nbsp;&nbsp; Nettoyage<br>
&nbsp;&nbsp;&nbsp; [ "$OPT" = "-V" ] &amp;&amp; Affichage<br>
&nbsp;&nbsp;&nbsp; exit 3<br>
&nbsp;&nbsp;&nbsp; ;;<br>
&nbsp;&nbsp;&nbsp; RIEN_A_FAIRE)<br>
&nbsp;&nbsp;&nbsp; echo "Aucune verification a effectuer sur $NET_HOSTNAME" &gt;&gt; $MESSAGE.Notice<br>
&nbsp;&nbsp;&nbsp; Nettoyage<br>
&nbsp;&nbsp;&nbsp; [ "$OPT" = "-V" ] &amp;&amp; Affichage<br>
&nbsp;&nbsp;&nbsp; exit 4<br>
&nbsp;&nbsp;&nbsp; ;;<br>
&nbsp;&nbsp;&nbsp; STATCONF)<br>
&nbsp;&nbsp;&nbsp; $AWK '{print $1,$2}' $2|sort|uniq -c|$AWK -v
CONF="$2" '$1 &gt; 1 {print "("CONF") : "$1" occurences pour "$2,$3}'
&gt;&gt; $MESSAGE.Notice<br>
&nbsp;&nbsp;&nbsp; ;;<br>
esac<br>
}<br>
      <br>
## VERBOSE : Analyse du fichier de congiguration generale<br>
#[ "$OPT" = "-V" ] &amp;&amp; signalementERRSTOP STATCONF $CONFIG_GEN<br>
      <br>
      <br>
##- Verif du binaire md5sum ou md5<br>
[ -x $MD5SUM ] ||&nbsp; signalementERRSTOP MD5NOTPRESENT<br>
      <br>
      <br>
##- VARIABLES GENEREES : PAYS NOM-RESEAU CATEGORIE<br>
#################################################################<br>
##- NOMENCLATURE DE LA VARIABLE CATEGORIE : PPOOOOOYYYYYY<br>
##- PP=Pays&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (am,at,du,fr,is,lo,ma,mi,ny,pa,st,vi,zu,bk)<br>
##- OOOO=OS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Linux,SunOS)<br>
##- YYYYYY=StatusNIS&nbsp; (YPBIND,YPSERV,AUTRES)<br>
      <br>
      <br>
##- PAYS : Le pays de la machine est le pays de son serveur NIS.<br>
##&nbsp; Certains serveurs NIS pointent sur eux-meme (localhost) et il faut remplacer cette info par le nom de la machine<br>
echo "s/^.*localhost.*$/$NET_HOSTNAME/" &gt; $WDIR/pays.sed<br>
PAYS=$(ypwhich 2&gt; /dev/null |sed -f $WDIR/pays.sed|cut -c1,2)<br>
PAYS=${PAYS:-$(uname -n|cut -c1,2)} #Pour les machines non NIS<br>
##- Si on a un pays connu on continue, sinon on termine en signalant l'erreur.<br>
echo $PAYS|$EGREP -x $LIST_PAYS &gt; /dev/null || signalementERRSTOP PAYSINCONNU<br>
      <br>
##- YP_STATUS : La machine est elle serveurNIS, clientNIS, ou autre ?<br>
YP_STATUS=AUTRES<br>
ypwhich 2&gt;/dev/null &gt;/dev/null &amp;&amp; {<br>
      <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; YP_STATUS=YPBIND<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ypcat -h panis001 -k ypservers &gt;/dev/null 2&gt;/dev/null<br>
&nbsp;&nbsp;&nbsp; then<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ypcat -h panis001 -k
ypservers|$AWK '{print $1}'|$GREP -x "$NET_HOSTNAME" &gt; /dev/null
&amp;&amp; YP_STATUS=YPSERV<br>
&nbsp;&nbsp;&nbsp; else<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ps -ef|grep ypserv|grep -v $$ &gt; /dev/null &amp;&amp; YP_STATUS=YPSERV<br>
&nbsp;&nbsp;&nbsp; fi<br>
}<br>
      <br>
##- DEFINITION DE "CATEGORIE" (Categorie a laquelle appartient la machine testee)<br>
CATEGORIE=$PAYS$OS$YP_STATUS<br>
[ "$OPT" = "-V" ] &amp;&amp; echo "CATEGORIE=$PAYS$OS$YP_STATUS" &gt;&gt; $MESSAGE.Notice<br>
      <br>
##- Extraction des lignes de categories identiques a celle de la machine<br>
$EGREP "^$CATEGORIE" $CONFIG_GEN | sort -u &gt; $CONFIG_CATEGORIE<br>
      <br>
##- Extraction des noms de machines generiques pertinants<br>
#########################################################<br>
##-Extraction des premiers champs en /reg_ex/ matchant le nom de la machine<br>
&gt; $CONFIG_GENERIQUE.1 #(generique.1)<br>
for REGEX in $($AWK '{print $1}' $CONFIG_GEN|$GREP "^\/[^ ^/][^ ^/]*\/$"|sed "s@/@@g"|sort -u)<br>
do<br>
&nbsp;&nbsp;&nbsp; echo $NET_HOSTNAME|$EGREP "$REGEX" &gt; /dev/null &amp;&amp; echo $REGEX &gt;&gt; $CONFIG_GENERIQUE.1<br>
done<br>
      <br>
##- extraction des lignes completes correspondantes<br>
&gt; $CONFIG_GENERIQUE #(generique)<br>
while read LINE<br>
do<br>
&nbsp;&nbsp;&nbsp; $AWK -v REGEX="/$LINE/" '$1 == REGEX {print}' $CONFIG_GEN &gt;&gt; $CONFIG_GENERIQUE<br>
done &lt; $CONFIG_GENERIQUE.1<br>
      <br>
      <br>
##- Extraction des noms de machines SPECIFIQUE.<br>
$EGREP "^$NET_HOSTNAME[ \t]" $CONFIG_GEN &gt; $CONFIG_SPECIF<br>
      <br>
#####################################- Extraction finale -###########################################<br>
&gt;${CONFIG_GEN}.extract.brut<br>
      <br>
##- Concatenation des donnees brutes concernant la machine<br>
cat $CONFIG_CATEGORIE $CONFIG_GENERIQUE $CONFIG_SPECIF &gt; ${CONFIG_GEN}.extract.brut<br>
      <br>
##- POUR CHACUN DES GROUPES "Categorie ; generique ; specifique", dresser la liste des fichiers a verifier sur la machine<br>
for GROUPE in $CONFIG_CATEGORIE $CONFIG_GENERIQUE $CONFIG_SPECIF<br>
do<br>
&nbsp;&nbsp;&nbsp; ##- extraction sans doublon des noms de fichiers a tester<br>
&nbsp;&nbsp;&nbsp; $AWK '{print $2}' $GROUPE | sort -u &gt; $GROUPE.fic.tocheck<br>
      <br>
&nbsp;&nbsp;&nbsp; ##- creation fichier vide a remplir $GROUPE.no_exist<br>
&nbsp;&nbsp;&nbsp; &gt;$GROUPE.no_exist<br>
&nbsp;&nbsp;&nbsp; &gt;$GROUPE.fic_exist<br>
&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp; ##- Et parmis eux, les quels existent sur la machine<br>
&nbsp;&nbsp;&nbsp; while read FIC2CHECK<br>
&nbsp;&nbsp;&nbsp; do<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ -f $FIC2CHECK ]<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; then<br>
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
$AWK -v FILE="$FIC2CHECK" '$2 == FILE {print}' $GROUPE&nbsp; &gt;&gt;
$GROUPE.fic_exist<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "$FIC2CHECK"&nbsp; &gt;&gt; $GROUPE.no_exist<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi<br>
&nbsp;&nbsp;&nbsp; done &lt; $GROUPE.fic.tocheck<br>
done<br>
      <br>
##- Concatenation des listes des fichiers *.no_exist pour en faire un filtre.<br>
cat $WDIR/*.no_exist &gt; $WDIR/no_exist_filtre<br>
##- supression des sous fichiers<br>
rm -f $WDIR/*.no_exist<br>
      <br>
##- Si ce fichier n'est pas vide, constituer le rapport no_exist<br>
[ -s $WDIR/no_exist_filtre ] &amp;&amp; {<br>
# Constititution du rapport<br>
$GREP -f $WDIR/no_exist_filtre ${CONFIG_GEN}.extract.brut &gt; $WDIR/rapport.no_exist<br>
}<br>
####################################################################<br>
# Pour la realisation de to_do<br>
# ****************************<br>
# initialiser filtre<br>
# initialiser to_do<br>
      <br>
# pour chaque groupe dans l'ordre : specifique ; generique ; categorie<br>
# si le groupe n'est pas vide<br>
#&nbsp;&nbsp;&nbsp; si le filtre n'est pas vide &nbsp;&nbsp;&nbsp; :ajouter le groupe filtr&amp; a to_do<br>
#&nbsp;&nbsp;&nbsp; si le filtre est vide &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; :ajouter le groupe a to_do<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Construire le filtre avec les fichiers inscrits dans to_do<br>
# si le groupe est vide, passer au suivant.<br>
      <br>
TO_DO=$WDIR/to_do ; &gt; $TO_DO<br>
FILTRE=$WDIR/filtre_to_do ; &gt; $FILTRE<br>
for GROUPE in $CONFIG_SPECIF.fic_exist $CONFIG_GENERIQUE.fic_exist $CONFIG_CATEGORIE.fic_exist<br>
do<br>
&nbsp;&nbsp;&nbsp; [ -s $GROUPE ] &amp;&amp;
{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#si le groupe n'est pas vide<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if [ -s $FILTRE
]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#si le filtre n'est pas vide<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
then&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#ajouter le groupe filtr&amp; a to_do<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; while read FIC_NAME<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; do<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; $AWK -v FIC_NAME="$FIC_NAME" '$2 == "FIC_NAME"
{print}' $GROUPE &gt;&gt; $TO_DO<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; done &lt; $FILTRE<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; else<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; cat $GROUPE &gt;&gt; $TO_DO&nbsp; #ajouter le groupe a to_do<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; fi<br>
&nbsp;&nbsp;&nbsp; awk '{print $2}' $TO_DO &gt;
$FILTRE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #definir le fitre avec noms
de fichiers existants dans to_do<br>
&nbsp;&nbsp;&nbsp; }<br>
done<br>
      <br>
# Si le fichier to_do est vide , fin de la mission :<br>
[ -s $TO_DO ] || signalementERRSTOP RIEN_A_FAIRE<br>
      <br>
##- VERBOSE : statistiques sur le fichier to_do<br>
[ "$OPT" = "-V" ] &amp;&amp; signalementERRSTOP STATCONF $TO_DO<br>
      <br>
## Rapport OK<br>
while read LIGNE<br>
do<br>
&nbsp;&nbsp;&nbsp; FILE=$(echo $LIGNE|$AWK '{print $2}')<br>
&nbsp;&nbsp;&nbsp; MD5_FIC=$($MD5SUM $FILE|sed "s@.*\([0-9a-f]\{32\}\).*@\1@")<br>
&nbsp;&nbsp;&nbsp; echo $LIGNE|$AWK -v MD5_FIC="$MD5_FIC" -v
HOST="$NET_HOSTNAME" 'MD5_FIC == $3 {print "OK "HOST":"$2"
("MD5_FIC")"}'<br>
done &lt; $TO_DO &gt; $WDIR/rapport.Test_OK<br>
cut -f2 -d: $WDIR/rapport.Test_OK|awk '{print $1}' &gt; $WDIR/Fic_OK<br>
      <br>
## TO_DO (-) les lignes des fichiers OK<br>
cat $TO_DO &gt; ${TO_DO}-OK<br>
[ -s $WDIR/Fic_OK ] &amp;&amp; {<br>
&nbsp;&nbsp;&nbsp; $GREP -vf $WDIR/Fic_OK $TO_DO &gt; ${TO_DO}-OK <br>
}<br>
      <br>
## Rapport KO<br>
while read LIGNE<br>
do<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FILE=$(echo $LIGNE|$AWK '{print $2}')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MD5_FIC=$($MD5SUM $FILE|sed "s@.*\([0-9a-f]\{32\}\).*@\1@")<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo $LIGNE|$AWK -v
MD5_FIC="$MD5_FIC" -v HOST="$NET_HOSTNAME" 'MD5_FIC != $3 {print
HOST":"$1,$2,MD5_FIC" expecting "$3}'<br>
done &lt; ${TO_DO}-OK &gt; $WDIR/rapport.Test_KO<br>
      <br>
      <br>
##-----------------------------------------------------------------<br>
## categorie/nom&nbsp;&nbsp;&nbsp; FICHIER&nbsp;&nbsp;&nbsp; md5_fic&nbsp;&nbsp;&nbsp; "expecting"&nbsp; md5_to_match<br>
##-----------------------------------------------------------------<br>
      <br>
[ "$OPT" = "-v" -o "$OPT" = "-V" ] || Nettoyage <br>
Nettoyage "rapport.Test_OK$|"<br>
[ "$OPT" = "-V" ] &amp;&amp; Affichage<br>
[ "$OPT" = "-v" ] &amp;&amp; cat $WDIR/rapport.Test_KO $WDIR/rapport.Test_OK 2&gt; /dev/null<br>
      <br>
      </td>
    </tr>







<tr style="height: 1300.5pt;">
<td style="padding: 11.25pt; background: rgb(204, 170, 185) none repeat scroll 0% 50%; -moz-background-clip: initial; -moz-background-origin: initial; -moz-background-inline-policy: initial; width: 1210px; height: 1300.5pt;">
<pre style="font-weight: bold;"><font size="+1"><a name="fixright"></a></font></pre>
      <small class="MsoNormal Section1">#############################################################################<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;#<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Auteur :
Laurent
Graignic
http://l.graignic.online&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Objet&nbsp; : Mettre deux machines en conformite
concernant&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
les droits et les appartenances de
fichiers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Usage&nbsp; : FixRight
LISTING_FIND_LS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"LISTING_FIND_LS" est obtenu a partir de la
commande&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(Exemple) find / -user prod -user cft -ls &gt;
LISTING_FIND_LS&nbsp; #<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Ce fichier est ensuite a transfere de la machine
de&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
reference vers la machine cible. Ce script est
alors&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
utilisable. Une fonction undo permet un retour
arriere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#<br>
#############################################################################<br>
#!/bin/ksh<br>
#set -x<br>
# Determination du systeme (Sun ou AIX)<br>
OS=INCONU<br>
uname -a|grep -i aix &gt; /dev/null &amp;&amp; OS=AIX<br>
uname -a|grep -i sun &gt; /dev/null &amp;&amp; OS=SOLARIS<br>
<br>
# En fonction de l'OS, choix de la commande grep<br>
################################################<br>
case $OS in<br>
AIX)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
GREP=/usr/bin/grep<br>
;;<br>
SOLARIS)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
GREP=/usr/xpg4/bin/grep<br>
;;<br>
INCONU)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Attention, systeme UNIX non determine, la commande grep doit
supporter l'option \"x\""<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
which grep<br>
;;<br>
esac<br>
<br>
# Test de l'argument<br>
[ -f $1 -a -s $1 ] || {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "fichier donne en argument invalide, Abort."<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
exit<br>
}<br>
# Le fichier donne en argument doit provenir d'un "find -ls" realise
sur la machine de reference.<br>
echo
"******************************************************************************<br>
Info :&nbsp; Le fichier donne en argument doit etre un listing de
fichiers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de type \"find ABSOLUTE_PATH [-option arg] -ls\" :<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
* Le point de depart de la recherche est un ou plusieurs chemins
absolus.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
* Les droits et appartanances de ce fichiers sont a reproduire sur
$(hostname).<br>
******************************************************************************"<br>
nettoyer()<br>
{<br>
# Nettoyage des fichiers vides et classement des autres<br>
########################################################<br>
for
FICHIER in warning.log $FICREF.travail not_found LOCAL.REP.formate
REF.REP.formate REF.FIC.formate LOCAL.FIC.formate LOCAL.COM.FIC
LOCAL.COM.REP DIFF.REP.<br>
formate REF.REP.DroitsSpeciaux
DIFF.FIC.formate REF.FIC.DroitsSpeciaux DIFF.REP.DroitsSpeciaux.formate
REF.REP.DroitsSpeciaux.ExpReg DIFF.REP.DroitsNormaux.fo<br>
rmate
DIFF.FIC.DroitsSpeciaux.formate REF.FIC.DroitsSpeciaux.ExpReg
DIFF.FIC.DroitsNormaux.formate DIFF.DroitsSpeciaux.formate
DIFF.DroitsNormaux.formate LOGG<br>
EN.$FICREF LOG.$FICREF<br>
do<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if [ -s $FICHIER ]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[ -d $FICREF.$$ ] || mkdir $FICREF.$$<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mv $FICHIER $FICREF.$$ 2&gt;/dev/null<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
rm $FICHIER 2&gt;/dev/null<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
fi<br>
done<br>
[ -s $FICREF.$$/LOG.$FICREF ] || rm undo.$$ 2&gt;/dev/null<br>
rm sed*.txt 2&gt;/dev/null<br>
exit<br>
}<br>
# En cas de sortie forcee<br>
trap nettoyer EXIT<br>
<br>
echo "Inspection du fichier $1 ? O/N [O]:"<br>
read REP<br>
[ "$REP" = "" ] &amp;&amp; REP=O<br>
[ "$REP" != "0" -a "$REP" != "o" ] &amp;&amp; exit 1<br>
FICREF=$(basename $1)<br>
# Mise a "0" des fichier de log specifique a cette cession et a ce
fichier de reference<br>
&gt;LOG.$FICREF<br>
&gt;LOGGEN.$FICREF<br>
<br>
#########################################<br>
#
Transformation du 'find -ls' en un format simplifie (Cette
transformation peut s'appliquer à son propre resultat sans le modifier
- utile pour le "undo"):<br>
# FORMAT :droits user group "chemin_absolu_fichier_ou_repertoire"<br>
#########################################<br>
echo
"s/^.*\([-bcdsl][rsSwx-]\{9\}\)[ \t][ \t]*[0-9][0-9]*[ \t][ \t]*\([^
][^ ]*\)[ \t][ \t]*\([^ ][^ ]*\)[^/][^/]*\(\/.*\)/\1 \2 \3 \"\4\"/"
&gt; sed.txt<br>
sed -f sed.txt $1 &gt; $FICREF.travail<br>
<br>
#########################################<br>
echo "Verification d'intégrité des donnees extraites ..."<br>
$GREP -vn "^[-bcdsl][rsSwx-]\{9\} [^ ][^ ]* [^ ][^ ]* .*$"
$FICREF.travail &amp;&amp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Probleme d'intégrité sur ces lignes, vérifier que $1 est bien
issu de la commande \"find /ABSOLUTE_PATH -ls\". Abort..."<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
exit<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
echo "---&gt;OK"<br>
<br>
<br>
<br>
#########################################<br>
#Verification des droits inscrits au fichier $FICREF.travail.<br>
echo "Inspection des droits dans $1..."<br>
awk
'{print $1}' $FICREF.travail|$GREP -n -v "[-cdbsl][-rwxSs]\{9\}"|awk
-F":" '{print "Ligne "$1"&gt;
\""$2"\":&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Droits invalides"}'|head|$GREP ".*" &amp;&amp; echo<br>
&nbsp;"Abort..." &amp;&amp; exit 1<br>
<br>
echo "Verification des utilisateurs inscrits dans $1"<br>
&gt;warning.log<br>
for USERS in $(awk '{print $2}' $FICREF.travail|sort -u)<br>
do<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
id $USERS &gt; /dev/null 2&gt;&gt; warning.log<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo $USERS|$GREP "^root$" &gt; /dev/null &amp;&amp; echo
"ATTENTION
!!!$(awk '$2 ~ /root/ {print}' $FICREF.travail|wc -l) fichiers \"root\"
sont inclus dans la<br>
liste des fichiers a controler"<br>
done<br>
<br>
[ -s warning.log ] &amp;&amp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "$(cat warning.log|tr -s '\012' " ") : Attention, ces utilisateurs
sont inconus du systeme"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Continuer la verification ? O/N [O]:"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
read REP<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[ "$REP" = "" ] &amp;&amp; REP=O<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[ "$REP" != "0" -a "$REP != "o" ] &amp;&amp; exit 1<br>
}<br>
##########################################<br>
echo "Verification des groupes inscrits dans $FICREF.travail..."<br>
GROUPS=$(awk '{print $3}' $FICREF.travail|sort -u|$GREP -v
"^[0-9][0-9]*$")<br>
[ "$GROUPS" != "" ] &amp;&amp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "$GROUPS : Attention, ces groupes sont inconus du systeme"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Continuer le rapport ? O/N [O]:"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
read REP<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[ "$REP" = "" ] &amp;&amp; REP=O<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[ "$REP" != "0" -a "$REP != "o" ] &amp;&amp; exit 1<br>
}<br>
echo "\nRepartition des fichiers inscrits dans \"$1\" par user et group
:<br>
NBRE USERS:GROUPS"<br>
awk '{print $2":"$3}' $FICREF.travail | sort | uniq -c|sort -nr<br>
<br>
#########################################<br>
# Sindage du fichier original en 4 fichiers formates:<br>
#&nbsp;&nbsp; "droits user group nom_fic" :<br>
# 1 pour les repertoires de reference<br>
# 1 pour les fichiers de reference<br>
# 1 pour les repertoires locaux correspondants presents<br>
# 1 pour les fichiers locaux correspondants presents<br>
#########################################<br>
$GREP "^[d][rsSwx-]\{9\}" $FICREF.travail &gt; REF.REP.formate<br>
sed "s/.*\(\".*\"\)$/\1/" REF.REP.formate | xargs ls -ld 2&gt;
not_found|sed -f sed.txt &gt; LOCAL.REP.formate<br>
$GREP "^[-l][rwsSx-]\{9\}" $FICREF.travail &gt; REF.FIC.formate<br>
sed "s/.*\(\".*\"\)$/\1/" REF.FIC.formate | xargs ls -ld
2&gt;&gt; not_found|sed -f sed.txt &gt; LOCAL.FIC.formate<br>
<br>
#########################################<br>
# Nombre de repertoires communs<br>
NBRE_REP_COM=$(wc -l LOCAL.REP.formate|awk '{print $1}')<br>
<br>
#########################################<br>
# Nombre de fichiers communs<br>
NBRE_FIC_COM=$(wc -l LOCAL.FIC.formate|awk '{print $1}')<br>
echo
"\nNOTE :&nbsp;&nbsp;&nbsp;&nbsp; $(wc -l not_found|awk
'{print $1}')
element(s) present(s) dans $FICREF sont introuvable(s) sur $(hostname)"<br>
<br>

#########################################<br>
# Fichiers communs et differents sur machine locale<br>
$GREP -v -x -f REF.FIC.formate LOCAL.FIC.formate | tee undo.$$ | sed
"s/.*\(\".*\"\)$/\1/" &gt; LOCAL.COM.FIC<br>
$GREP -f LOCAL.COM.FIC REF.FIC.formate &gt; DIFF.FIC.formate<br>
NBRE_FIC_DIFF=$(wc -l DIFF.FIC.formate|awk '{print $1}')<br>
<br>
#########################################<br>
# Repertoires communs et differents sur machine locale<br>
$GREP -v -x -f REF.REP.formate LOCAL.REP.formate | tee -a undo.$$ |sed
"s/.*\(\".*\"\)$/\1/" &gt; LOCAL.COM.REP<br>
$GREP -f LOCAL.COM.REP REF.REP.formate &gt; DIFF.REP.formate<br>
NBRE_REP_DIFF=$(wc -l DIFF.REP.formate|awk '{print $1}')<br>
<br>
#########################################<br>
# Extraction des droits spéciaux inscrits dans ces fichiers :<br>
awk '{print $1}' DIFF.REP.formate | $GREP -i s | sort -u &gt;
REF.REP.DroitsSpeciaux<br>
awk '{print $1}' DIFF.FIC.formate | $GREP -i s | sort -u &gt;
REF.FIC.DroitsSpeciaux<br>
<br>
#########################################<br>
# Transformation en expression reguliere<br>
awk '{print "^"$0}' REF.REP.DroitsSpeciaux &gt;
REF.REP.DroitsSpeciaux.ExpReg<br>
awk '{print "^"$0}' REF.FIC.DroitsSpeciaux &gt;
REF.FIC.DroitsSpeciaux.ExpReg<br>
<br>
#########################################<br>
# Repertoires communs, differents, sur distant, ayant des droits Normaux<br>
cat DIFF.REP.formate | $GREP -E -v -f REF.REP.DroitsSpeciaux &gt;
DIFF.REP.DroitsNormaux.formate<br>
NBRE_REP_DIFF_NORM=$(wc -l DIFF.REP.DroitsNormaux.formate|awk '{print
$1}')<br>
<br>
#########################################<br>
# Fichiers communs, differents, sur distant, ayant des droits Normaux<br>
cat DIFF.FIC.formate | $GREP -E -v -f REF.FIC.DroitsSpeciaux &gt;
DIFF.FIC.DroitsNormaux.formate<br>
NBRE_FIC_DIFF_NORM=$(wc -l DIFF.FIC.DroitsNormaux.formate|awk '{print
$1}')<br>
<br>
#########################################<br>
# Repertoires communs, differents, sur distant, ayant des droits
Speciaux<br>
cat DIFF.REP.formate | $GREP -E -f REF.REP.DroitsSpeciaux.ExpReg
&gt; DIFF.REP.DroitsSpeciaux.formate<br>
NBRE_REP_DIFF_SPEC=$(wc -l DIFF.REP.DroitsSpeciaux.formate|awk '{print
$1}')<br>
<br>
#########################################<br>
# Fichiers communs, differents, sur distant, ayant des droits Speciaux<br>
cat DIFF.FIC.formate | $GREP -E -f REF.FIC.DroitsSpeciaux.ExpReg
&gt; DIFF.FIC.DroitsSpeciaux.formate<br>
NBRE_FIC_DIFF_SPEC=$(wc -l DIFF.FIC.DroitsSpeciaux.formate|awk '{print
$1}')<br>
<br>
#########################################<br>
# Concatenation pour droits normaux :<br>
cat DIFF.REP.DroitsNormaux.formate DIFF.FIC.DroitsNormaux.formate
&gt; DIFF.DroitsNormaux.formate<br>
<br>
#########################################<br>
# Possibilité de retrait selectif des fichiers particuliers (Socket,
bloc) + Retrait systematique des fichiers en mode caractere<br>
$GREP "^[scb][rsSwx-]\{9\}" DIFF.DroitsNormaux.formate &gt;
/dev/null || {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Certains fichiers sont du type Socket ou fichier special en mode
bloc ou caractere et diffèrent sur $(hostname)<br>
Sont ils a prendre en compte dans l'analyse ?<br>
Choisir entre : [sb] -&gt; Oui pour TOUS ; \"s\" -&gt; socket ;
\"b\" -&gt; bloc ; \"N\" -&gt; NON pour Aucun"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
read REP<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[ "$REP" = "" ] &amp;&amp; REP=sb<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
until $(echo $REP|$GREP "[Nsb]\{1,3\}" &gt; /dev/null)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
do<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "REPONSE parmis : N (Pour aucun), s ; b ou sb (Pour TOUS)"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
read REP<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
done<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo $REP|$GREP N &gt;/dev/null &amp;&amp; REP=N<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Reponse = $(echo $REP|sed "s/s/Sockets /"|sed "s/b/Bloc /"|sed
"s/N/ Aucun/")"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
$GREP "^[-dl$REP]" DIFF.DroitsNormaux.formate &gt;
DIFF.DroitsNormaux.formate-<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mv DIFF.DroitsNormaux.formate- DIFF.DroitsNormaux.formate<br>
}<br>
NBRE_DIFF_NORM=$(wc -l DIFF.DroitsNormaux.formate|awk '{print $1}')<br>
<br>
#########################################<br>
# Concatenation pour droits Speciaux :<br>
cat DIFF.REP.DroitsSpeciaux.formate DIFF.FIC.DroitsSpeciaux.formate
&gt; DIFF.DroitsSpeciaux.formate<br>
NBRE_DIFF_SPEC=$(wc -l DIFF.DroitsSpeciaux.formate|awk '{print $1}')<br>
<br>
echo
"\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*****************************************************<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
RAPPORT DE COMPARAISON \"$1\" VS $(hostname)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*****************************************************<br>
<br>
Sur
les $(cat $FICREF.travail|wc -l|awk '{print $1}') fichiers ou
repertoires inscrits dans le fichier \"$1\", $NBRE_FIC_COM fichiers et
$NBRE_REP_COM<br>
repertoires sont communs aux deux environnements."<br>
echo "Sur ce nombre, $(expr $NBRE_DIFF_NORM + $NBRE_DIFF_SPEC)
possèdent une appartenance ou des droits differents.\n"<br>
<br>
if [ -s DIFF.DroitsSpeciaux.formate ]<br>
then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Parmis ceux-ci, $NBRE_FIC_DIFF_SPEC fichiers et
$NBRE_REP_DIFF_SPEC répertoires possedent les droits speciaux suivants :<br>
$(cat DIFF.DroitsSpeciaux.formate|awk '{print $1}'|tr -s '\012' " "),
et ne pourrons pas etre modifies automatiquement.\n"<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "La repartitions par utlisateurs et groupes est la suivante :<br>
$(echo "NBRE USERS:GROUPS";cat DIFF.DroitsSpeciaux.formate|awk '{print
$2":"$3}'|sort|uniq -c)"<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "\nLa liste de ces $NBRE_DIFF_SPEC fichiers et/ou repertoires est
contenue<br>
dans le fichier \"DIFF.DroitsSpeciaux.formate\", dont apercu :<br>
$(head DIFF.DroitsSpeciaux.formate)<br>
&nbsp;&nbsp; etc...\n"<br>
<br>
else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "les droits et appartenances sont identiques pour les fichiers
ayant des droits Speciaux.<br>
Aucune modification n'est a effectuer.\n"<br>
fi<br>
<br>
if [ -s DIFF.DroitsNormaux.formate ]<br>
then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Le nombre de fichiers differents en droits et/ou appartenance,
ayant des droits classiques et pouvant être corrigés automatiquement
est de $NBRE<br>
_DIFF_NORM.<br>
La repartitions par utlisateurs et groupes est la suivante :<br>
$(echo "NBRE USERS:GROUPS";cat DIFF.DroitsNormaux.formate|awk '{print
$2":"$3}'|sort|uniq -c)<br>
Voulez-vous lancer ces corrections ?"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
read REP<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[ "$REP" != "0" -a "$REP" != "o" ] &amp;&amp; exit {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
# Pour fournir un etat d'avancement de l'execution du script<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
CURRENT=0<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
# Modification sur local de tous les fichiers differents avec droit
normaux<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
while read LIGNE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
do<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DROIT=$(echo $LIGNE|awk '{print $1}')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
U=$(echo $DROIT|cut -c2-4|sed "s/--*//"|sed "s/-//")<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
G=$(echo $DROIT|cut -c5-7|sed "s/--*//"|sed "s/-//")<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
O=$(echo $DROIT|cut -c8-10|sed "s/--*//"|sed "s/-//")<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
USER=$(echo $LIGNE|awk '{print $2}')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
GROUP=$(echo $LIGNE|awk '{print $3}')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
NOMFIC=$(echo $LIGNE|sed "s/.*\(\".*\"\)$/\1/")<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
CURRENT=$(expr $CURRENT + 1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
# ACTIONS<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Modification ($CURRENT / $NBRE_DIFF_NORM) de $NOMFIC"|tee -a
LOGGEN.$FICREF<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Modification de $NOMFIC :" &gt;&gt; LOG.$FICREF<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Avant : $(echo $NOMFIC|xargs ls -ld)" &gt;&gt; LOG.$FICREF<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo $NOMFIC|xargs chmod u=$U,g=$G,o=$O &amp;&amp; echo "chmod
u=$U,g=$G,o=$O" &gt;&gt; LOG.$FICREF &amp;&amp; echo
"chmod OK"|tee -a
LOGGEN.$FICREF<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo $NOMFIC|xargs chown $USER:$GROUP &amp;&amp; echo "chown
$USER:$GROUP" &gt;&gt; LOG.$FICREF &amp;&amp; echo
"chown OK"|tee -a
LOGGEN.$FICREF<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo "Apres : $(echo $NOMFIC|xargs ls -ld)" &gt;&gt; LOG.$FICREF<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
done &lt; DIFF.DroitsNormaux.formate<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo " Travail terminé, pour un retour arriere, lancer la commande
\"./$(basename $0) undo.$$\""<br>
<br>
else<br>
echo "les droits et appartenances sont identiques pour les fichiers
ayant des droits classiques.<br>
Aucune modification n'est a effectuer."<br>
fi</small><br>
</td>
</tr><tr>
      <td style="vertical-align: top; background-color: rgb(255, 255, 204); width: 1210px;"><span style="font-family: Courier New;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Script frontal permettant, sur un domaine NIS, de trouver très
facilement et rapidement dans la base utilisateur<br>
&nbsp;&nbsp;&nbsp;&nbsp; le login d'un utilisateur, et partant de là,
son groupe d'appartenance, son adresse mail, les commentaires le<br>
&nbsp;&nbsp;&nbsp;&nbsp; concernant, le nom du serveur et du répertoire
ou se trouve son compte ainsi que la date de son dernier accès.<br>
&nbsp;&nbsp;&nbsp;&nbsp; Une fois ces informations délivrées, permet le
lancement de plusieurs programmes au nom de l'utilisateur.<br>
&nbsp;&nbsp;&nbsp;&nbsp; (Comme le lancement d'un shell indépendant, la
gravure d'un CD de sortie de données confidentiels, le lancement<br>
&nbsp;&nbsp;&nbsp;&nbsp; d'un travail d'impression grand format, la
réinitialisation du processus d'affichage de sa machine si celle-ci est
de<br>
&nbsp;&nbsp;&nbsp;&nbsp; type IRIX, etc....<br>
      <br>
#!/usr/bin/ksh<br>
#Tag 1<br>
#set -x<br>
&nbsp;<br>
      <br>
##############ASSISTANT DE CHANGEMENT D'IDENTITE######################<br>
DISP=`hostname`:0<br>
LOG=$1<br>
while true<br>
do<br>
&nbsp;&nbsp;&nbsp;&nbsp; echo $LOG|grep -v "[0-9a-zA-Z]\{3,\}" &gt;/dev/null&nbsp; &amp;&amp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp; LOG=":::::"<br>
&nbsp;&nbsp;&nbsp;&nbsp; echo "(...minimum 3 caracteres pour la recherche)"<br>
&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; until [ -d ~$LOG ]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LOGINS=`ypcat passwd|grep -i "$LOG"|cut -f1 -d":"|tr -s '\012' " "`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DEFAULT=`echo $LOGINS|cut -f1 -d" "`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo
"\n$LOGINS\nChoisir un login ou rechercher avec [$DEFAULT] ===&gt;\c"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; read LOG<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [ "$LOG" = "" ] &amp;&amp; LOG=$DEFAULT<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo
$LOG|grep -v "[0-9a-zA-Z]\{3,\}" &gt;/dev/null&nbsp; &amp;&amp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LOG=":::::"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "...minimum 3 caracteres alfa-num pour la recherche"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp; done<br>
&nbsp; GROUP=`groups $LOG`<br>
&nbsp; COMMENT=`ypmatch $LOG passwd.byname|cut -f5 -d":"`<br>
&nbsp; REPER=`ypmatch $LOG passwd.byname|cut -f6 -d":"`<br>
&nbsp; SERVEUR=`df $REPER|tail -1|cut -f1 -d" "`<br>
&nbsp; EMAIL=`ypmatch -k $LOG aliases 2&gt;/dev/null|cut -f2 -d" "`<br>
&nbsp; [ "$EMAIL" = "" ] &amp;&amp; EMAIL="!!!!!!E-mail Non-definie!!!!!!"<br>
&nbsp; LASTMOD=`\ls -ld ~$LOG|awk '{ print $7,$6,"a",$8 }'`<br>
&nbsp; echo "\nLOGIN GROUPE:&nbsp; $LOG-$GROUP ($EMAIL)"<br>
&nbsp; echo "COMMENTAIRES :&nbsp; $COMMENT"<br>
&nbsp; echo "REPERTOIRE :&nbsp; $SERVEUR (Modifie le $LASTMOD)"<br>
&nbsp; echo "\n*********************** MENU: ************************"<br>
&nbsp; echo "&lt;:&gt;&nbsp; pour devenir $LOG &lt;:g&gt; pour Gravage"<br>
&nbsp; echo "&lt;:i&gt; pour Imprimer&nbsp; &lt;:m&gt; envoyer un Message"<br>
&nbsp; echo "&lt;:k&gt; pour Kill/start de 4Dwm"<br>
&nbsp; echo "*******************************************************"<br>
&nbsp; echo "Choix du menu ou Rechercher avec ===&gt;\c"<br>
&nbsp; read IN<br>
case "$IN" in<br>
:i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xhost + emma&gt;/dev/null<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "Lancement de sicprint sur emma"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "Choisir \"Fichier/Abandon\" pour quitter sicprint"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sudo -b su - $LOG -c "rsh emma -n
\"setenv DISPLAY $DISP ; /net/bin/sicprintEpsonHL\"" 2&gt;|/dev/null<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :g)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "utiliser: burn No_de_demande fichiers_repertoires"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sudo -b su $LOG -c "cd ~$LOG/;&nbsp; winterm -bg black"&gt;/dev/null<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>
:m)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ "$TRUC" != "" ]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mes $TRUC<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "pas de machine IRIX definie, abandon"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>
:k)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ "$TRUC" != "" ]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; k4d $TRUC<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "pas de machine IRIX definie, abandon"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>
:)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sudo su - $LOG<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [0-9a-zA-Z]*) LOG=$IN<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>
&nbsp;<br>
esac<br>
echo "\n"<br>
done<br>
      <br>
&nbsp;<br>
      </span><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top; background-color: rgb(255, 204, 255); width: 1210px;"><span style="font-family: Courier New;">&nbsp;Script permettant de renommer en masse des fichiers dans un répertoire.<br>
      <br>
&nbsp;<br>
      <br>
#!/usr/bin/ksh<br>
      <br>
# Script permettant de renommer en masse des fichiers dans un répertoire.<br>
# les fichiers qui seront renommés sont sélectionné par critère de nom.<br>
# Est entendu par "extention" la partie commençant par le dernier point dans le nom du fichier.<br>
# Est entendu par préfixe la partie du nom qui précède le dernier point dans le nom du fichier.<br>
# Exemple: "dupont.mardi.NEW.doc" a pour préfixe "dupont.mardi.NEW" et pour extension ".doc"<br>
# Les modifications ne s'appliquent qu'aux extentions des fichiers :<br>
# Remplacement (Si une extension existe)<br>
# Rajout si le nom ne comporte pas de point<br>
#*******************************************<br>
# Note : Si l'extension choisie pour le remplacement ne commence pas par un point, <br>
# c'est le préfixe qui sera modifié de façon irréversible.<br>
# Dans ce cas, le script ne pourra plus renommer selon le préfixe d'origine.<br>
# Une confirmation est alors nécessaire pour le renommage. <br>
      <br>
      <br>
#*******************************************************************<br>
# Ecrit par Laurent graignic http://l.graignic.online.fr/ #<br>
# ******************************************************************<br>
      <br>
TMP=/var/tmp # Emplacement des fichier temporaires<br>
clear ### Prépare l'écran pour 1 affichage clair du prochain "ls"<br>
while true<br>
do <br>
NBR1=0 ### Nombre de fichier sélectionnés<br>
while [ $NBR1 -eq 0 ] ### tant qu'il y a 0 fichier sélectionné, on sort pas de la boucle<br>
do ### saisie des critères, affichage du nombre de fichiers sélectionnés.<br>
ls <br>
echo "Aucun fichier selectionné, Taper \"/\" pour finir."<br>
echo "Selection des fichiers (Meta-caractères acceptés):"<br>
read CHAIN <br>
[ "$CHAIN" = "/" ] &amp;&amp; { rm -f $TMP/*.$$ ; echo "Aurevoir" ; exit <br>
}<br>
ls $CHAIN &gt; $TMP/liste.$$<br>
NBR1=`cat $TMP/liste.$$|wc -l`<br>
done<br>
      <br>
# Affichage du nbre de fichiers sélectionnés et de leur nom.<br>
echo "$CHAIN = $NBR1 fichier(s) selectionne(s):"<br>
cat $TMP/liste.$$|tr -s '\012' " "<br>
echo ""<br>
      <br>
# saisie de l'extension de remplacement ou sortie du programme.<br>
echo "Entrer le nom de la nouvelle extension, ou \"/\" pour finir:"<br>
read NEW<br>
[ "$NEW" = "/" ] &amp;&amp; { echo "Au revoir" ; rm -f $TMP/*.$$ ; exit<br>
}<br>
      <br>
# Détection des extentions ne commençant pas par un point.<br>
WARN=`echo $NEW|grep "^[.].*"` <br>
if [ "$WARN" = "" ] <br>
then<br>
echo "Attention : L'extension ne comporte pas de point!!!"<br>
echo "Risque de modification irréversible des préfixes de noms"<br>
echo "Continuer ? [o/n]:"<br>
read OK<br>
      <br>
# Passer outre l'avertissement ? Sinon retour au début su script.<br>
if [ "$OK" != "o" -a "$OK" != "O" ]<br>
then<br>
rm -f *.$$a<br>
continue 2 # Retour au début du script.<br>
fi<br>
fi<br>
      <br>
# création d'un fichier comprenant, par ligne, un nom décomposé en "préfixe/extension".<br>
cat $TMP/liste.$$ | sed 's/^\(.*\)\([.].*\)/\1\/\2/' &gt; $TMP/noext.$$<br>
NBR2=0 # nombre de fichiers renommés pour l'instant = à zéro.<br>
      <br>
# Renomage avec la nouvelle extension de tous les fichiers sélectionnés.<br>
for LIGNE in `cat $TMP/noext.$$`<br>
do<br>
NAME=`echo $LIGNE|awk -F"/" '{ print $1 }'`<br>
OLDEXT=`echo $LIGNE|awk -F"/" '{ print $2 }'`<br>
# Renomage des fichiers suivi d'un rapport si la modification est effective.<br>
if mv $NAME$OLDEXT $NAME$NEW<br>
then echo "Le fichier $NAME$OLDEXT a ete renommé : $NAME$NEW"<br>
NBR2=`expr $NBR2 + 1`<br>
fi<br>
done<br>
echo "****** $NBR2 fichier(s) ont été renomé(s) ******"<br>
\rm -f $TMP/*.$$ <br>
done<br>
      </span><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top; background-color: silver; width: 1210px;"><span style="font-family: Courier New;">Relance à distance du procesus de l'interface graphique IRIX<br>
<br>
<br>
#!/usr/bin/ksh<br>
#Tag 1<br>
#set -x<br>
<br>
#-----------------------------------------------------------------------------------------#<br>
# Relance de 4Dwm sur une machine distante. Il faut etre sudoers pour&nbsp;&nbsp;&nbsp;&nbsp; #<br>
# executer ce script&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
#&nbsp; Codes de sortie: 0 -&gt; ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
#&nbsp;&nbsp;&nbsp;&nbsp; 1 -&gt; Argument invalid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
#&nbsp;&nbsp;&nbsp;&nbsp; 2 -&gt; Pas de processus 4Dwm sur destination&nbsp;&nbsp; #<br>
#&nbsp;&nbsp;&nbsp;&nbsp; 3 -&gt; destination est inacessible&nbsp;&nbsp;&nbsp; #<br>
#&nbsp;&nbsp;&nbsp;&nbsp; 4 -&gt; Impossible de killer 4Dwm&nbsp;&nbsp;&nbsp;&nbsp; #<br>
#&nbsp;&nbsp;&nbsp;&nbsp; 5 -&gt; Renoncement volontaire&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
#&nbsp;&nbsp;&nbsp;&nbsp; 6 -&gt; Pas d'utilisateur 4Dwm&nbsp;&nbsp;&nbsp;&nbsp; #<br>
#-----------------------------------------------------------------------------------------#<br>
<br>
############## Verif formattage commande #################################################<br>
[ $# -ne 1 ] &amp;&amp; { echo "Argument invalide";exit 1<br>
}<br>
<br>
############## La machine est-elle acessible #############################################<br>
if ping -qo -c1 -h $1 2&gt; /dev/null &gt;/dev/null<br>
then continue<br>
else<br>
&nbsp;echo "$1 est inacessible !!!"<br>
&nbsp;exit 3<br>
fi<br>
############## Histoire de taper son code une bonne fois pour toute ######################<br>
sudo echo "Password OK"<br>
<br>
############## Recuperation du PID et du user de 4DWM&nbsp; de la machine distante ############<br>
VAR=`rsh $1&nbsp; -n "ps -ef"|grep 4Dwm|grep -v grep | awk '{print $1,$2}'`<br>
if [ "$VAR" = "" ]<br>
then<br>
&nbsp;echo "Pas de processus 4Dwm sur $1"<br>
else<br>
&nbsp;XUSER=`echo $VAR|cut -f1 -d" "`<br>
&nbsp;PID=`echo $VAR|cut -f2 -d" "`<br>
fi<br>
############# definition d'une variable intermediaire indispensable au lancement de 4Dwm #<br>
CONFIG4DWM="/tmp/4Dwmrc.$XUSER:0"<br>
<br>
############# construction en plusieurs etape de la variable CMDE #########################<br>
############# qui est la ligne de commande servant a lancer 4Dwm ##########################<br>
CMDE=`rsh $1&nbsp; -n "grep configFile /var/X11/xdm/Xsession.dt"`<br>
CMDE=\""$CMDE"\"<br>
############# utilisation de la variable intermediaire ####################################<br>
CMDE=`eval echo $CMDE`<br>
<br>
############# lignes de debug ##############################################################<br>
if [ "$XUSER" = "" ]<br>
then echo "Pas d'utilisteur 4Dwm ..."<br>
&nbsp;echo "Entrer le login de l'utilisateur:\c"<br>
&nbsp;read XUSER<br>
&nbsp;echo "lancement de 4dwm ?"<br>
&nbsp;read YES<br>
&nbsp;[ "$YES" != "y" -a "$YES" != "Y" ] &amp;&amp; exit 6<br>
else<br>
&nbsp;echo "Utlisteur 4Dwm:&nbsp;&nbsp; $XUSER"<br>
&nbsp;echo "Continuer [o/n]:\c"<br>
&nbsp;read OK<br>
&nbsp;[ "$OK" != "o" -a "$OK" != "O" ] &amp;&amp; exit 5<br>
fi<br>
&nbsp;<br>
<br>
############# creation du fichier sur la machine distante contenant la ####################<br>
############# ligne de commande pour le lancementde 4Dwm ##################################<br>
rsh $1 -n echo "\#\!/usr/bin/ksh" "&gt;" /var/tmp/lance4Dwm ";" chmod 777 /var/tmp/lance4Dwm<br>
rsh $1 -n echo "export DISPLAY=$1:0" "&gt;&gt;" /var/tmp/lance4Dwm<br>
rsh $1 -n echo \""$CMDE"\" "&gt;&gt;" /var/tmp/lance4Dwm<br>
<br>
############# explosement du processus foireux de 4Dwm sur la machine distante ############<br>
sudo su $XUSER -c "rsh $1 -n \"kill -9 $PID\"" &amp;&amp; echo "4Dwm (PID:$PID) killed"<br>
[ "$?" -ne 0 ] &amp;&amp; { echo "Attention 4Dwm toujours actif, abandon ..." ; exit 4<br>
}<br>
<br>
############# relance de 4Dwm sur la machine distante #####################################<br>
sudo su - $XUSER -c "rsh $1 -n /var/tmp/lance4Dwm" &amp;&amp; echo "Relance de 4Dwm ..."<br>
exit 0</span></td>
    </tr>
    


</tbody>
</table>
<p><a href="index.html">Retour à l'accueil</a>
<br>
&nbsp;</p>
</div>
</body></html>
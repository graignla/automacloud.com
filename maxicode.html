<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>maxicode</title>
</head>
<body><span style="font-family: Consolas;">hostMinLong = ip2long(<span style="color: rgb(204, 51, 204);">hostMin</span>)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">hostMaxLong = ip2long(<span style="color: rgb(204, 51, 204);">hostMax</span>)</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.debug("hostMin = "+<span style="color: rgb(204, 51, 204);">hostMin</span>+" ("+hostMinLong+")")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.debug("hostMax = "+<span style="color: rgb(204, 51, 204);">hostMax</span>+" ("+hostMaxLong+")")</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Verification que les scopes sont bien dans le cidr</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.debug("check ipPools In CIDR: ")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">for each(ipPool in <span style="color: rgb(204, 51, 204);">ipPools</span>){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;result = chkRangeInScope(ipPool,<span style="color: rgb(204, 51, 204);">hostMin</span>,<span style="color: rgb(204, 51, 204);">hostMax</span>,true) <span style="color: rgb(153, 153, 153);">// true: affiche debug</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(result != "succeed"){ <span style="color: rgb(153, 153, 153);">// Failed (string)</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;System.error(result)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;throw result <span style="color: rgb(153, 153, 153);">// Si le pool n'est pas dans le cidr, pas la peine de regarder le reste</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;} </span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.log(<span style="color: rgb(204, 51, 204);">ipPools</span>.length+" ipPools: "+JSON.stringify(<span style="color: rgb(204, 51, 204);">ipPools</span>).replace(/."ipBegin"/g,"\n{ipBegin\""))</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// reduction overlapp des ipPools</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">reducedIpPools = reduceOverlapp(<span style="color: rgb(204, 51, 204);">ipPools</span>) ; System.debug("reducedIpPools = "+reducedIpPools.join(", "))</span><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Transformation des ipPools en un json de busyRanges optimis�s (version ipLong)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">forbiddenLongRangesPools = translateIntervalInRange(hostMinLong,hostMaxLong,reducedIpPools)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.debug("forbiddenLongRangesPools = "+JSON.stringify(forbiddenLongRangesPools))</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.debug("Pool nbAvailableIP: "+(<span style="color: rgb(204, 51, 204);">numberOfHost</span> - nbAvailableIP))</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Nouveau json, reflet du pr�c�dent, mais avec des IP au lieu des ipLong</span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Pour qu'il soit au m�me format que les autres ranges d'exclusions</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">forbiddenRangesPool = []</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">for each (ipLong in forbiddenLongRangesPools){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;newLine = new Properties</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;newLine.ipBegin = long2ip(ipLong.ipBegin) ; newLine.ipEnd = long2ip(ipLong.ipEnd)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;forbiddenRangesPool.push(newLine)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.debug("forbiddenRangesPool = "+JSON.stringify(forbiddenRangesPool))</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Verif listOfBusyRange are all in cidr</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">if(!listOfBusyRange){ listOfBusyRange = [] }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.log("listOfBusyRange is "+<span style="color: rgb(204, 51, 204);">listOfBusyRange</span>.length+" long")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.debug("listOfBusyRange:"+JSON.stringify(<span style="color: rgb(204, 51, 204);">listOfBusyRange</span>).replace(/."ipBegin"/g,"\n{ipBegin\""))</span><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// verif, bien dans le cidr</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">for each(range in <span style="color: rgb(204, 51, 204);">listOfBusyRange</span>){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;result = chkRangeInScope(range,<span style="color: rgb(204, 51, 204);">hostMin</span>,<span style="color: rgb(204, 51, 204);">hostMax</span>,true) <span style="color: rgb(153, 153, 153);">// false: quiet: no debug</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(result != "succeed"){ <span style="color: rgb(153, 153, 153);">// Failed (string)</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;System.error("listOfBusyRange check :"+result)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Errors.push("listOfBusyRange check :"+result) </span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas;">otherExclusionRanges = []</span><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// transformation de "listOfBusyIPs" en busyRanges: Array Of {"ipBegin":"xx.xx.xx.xx","ipEnd":"xx.xx.xx.xx"}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">if(!<span style="color: rgb(204, 51, 204);">listOfBusyIPs</span>){ <span style="color: rgb(204, 51, 204);">listOfBusyIPs</span> = [] }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.log("listOfBusyIPs = ["+<span style="color: rgb(204, 51, 204);">listOfBusyIPs</span>.join(", ")+"]")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">for each (ip in <span style="color: rgb(204, 51, 204);">listOfBusyIPs</span>){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;newLine = new Properties</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;newLine.ipBegin = ip ; newLine.ipEnd = ip</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;otherExclusionRanges.push(newLine)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">Errors = []</span><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Verification de tous les busyRanges dans le cidr</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">for each(range in otherExclusionRanges){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;result = chkRangeInScope(range,<span style="color: rgb(204, 51, 204);">hostMin</span>,<span style="color: rgb(204, 51, 204);">hostMax</span>,true) <span style="color: rgb(153, 153, 153);">// false: quiet: no debug</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(result != "succeed"){ <span style="color: rgb(153, 153, 153);">// Failed (string)</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;System.error("listOfBusyIPs check :"+result)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Errors.push("listOfBusyIPs check :"+result) </span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// transformation de "frozzenIPs" en busyRanges: Array Of {"ipBegin":"xx.xx.xx.xx","ipEnd":"xx.xx.xx.xx"}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">frozzenIPsRanges = []</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">if(!<span style="color: rgb(204, 51, 204);">frozzenIPs</span>){ <span style="color: rgb(204, 51, 204);">frozzenIPs</span> = [] }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.log("frozzenIPs = ["+<span style="color: rgb(204, 51, 204);">frozzenIPs</span>.join(", ")+"]")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">for each (ip in <span style="color: rgb(204, 51, 204);">frozzenIPs</span>){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;newLine = new Properties</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;newLine.ipBegin = ip ; newLine.ipEnd = ip</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;frozzenIPsRanges.push(newLine)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Verification des "frozzenIPsRanges" dans le cidr</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">for each(range in frozzenIPsRanges){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;result = chkRangeInScope(range,<span style="color: rgb(204, 51, 204);">hostMin</span>,<span style="color: rgb(204, 51, 204);">hostMax</span>,true) <span style="color: rgb(153, 153, 153);">// false: quiet: no debug</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(result != "succeed"){ <span style="color: rgb(153, 153, 153);">// Failed (string)</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;System.error("frozzenIPs check: "+result)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Errors.push("frozzenIPs check: "+result) </span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// G�n�rer erreur si il y en a</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">if(Errors.length &gt; 0){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;throw Errors.join(",")<span style="color: rgb(153, 153, 153);">// inutile d'aller plus loin si les v�rifications précédentes n'ont pas abouties</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}else{</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;System.log("All inputs checked OK")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// constitution de allExclusionRanges</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">allExclusionRanges = forbiddenRangesPool.concat(<span style="color: rgb(204, 51, 204);">listOfBusyRange</span>).concat(otherExclusionRanges).concat(frozzenIPsRanges)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.debug("allExclusionRanges = "+JSON.stringify(allExclusionRanges).replace(/."ipBegin"/g,"\n{ipBegin\""))</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// reduce overlapp sur allExclusionRanges:</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">reducedAllExclusionRanges = reduceOverlapp(allExclusionRanges)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.debug("reducedAllExclusionRanges = "+reducedAllExclusionRanges.join(", "))</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Transformation de reducedAllExclusionRanges en "autorizedRanges" optimis�s</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">autorizedRanges = translateIntervalInRange(hostMinLong,hostMaxLong,reducedAllExclusionRanges)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">System.log("nbAvailableIP = "+nbAvailableIP)</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Trouver la première IP disponible dans les ranges constitu�s</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">for(I in autorizedRanges){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;interval = resultArray[I]</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;nextFreeIP = long2ip(interval.ipBegin)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;System.log("For external net "+externalNetworkName+" scope
"+scopeNumber+",&nbsp; NextFreeIP = "+nextFreeIP+"
("+interval.ipBegin+")")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;break</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">if(!nextFreeIP){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;message = "No more available IP address in the scope "+scopeNumber+" of "+externalNetworkName</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;throw message</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">////////////////////////////////////////////////&nbsp; FONCTIONS /////////////////////////////////////////////</span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Fonction Supression overlapp:</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">function
reduceOverlapp(_ranges){ <span style="color: rgb(153, 153, 153);">// _ranges ArrayType:
[{"ipBegin":"10.130.31.100","ipEnd":"10.130.31.105"},{"ipBegin":"10.130.31.107","ipEnd":"10.130.31.120"}]</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp; &nbsp;// 1) Création d'une liste composite clé=(ipBegin|ipEnd) value = ip à partir de "exclusionRanges"</span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp;
&nbsp;//&nbsp;&nbsp;&nbsp; Ex:
[{"ipBegin":"10.130.31.100"},{"ipEnd":"10.130.31.105"},{"ipBegin":"10.130.31.107"},{"ipEnd":"10.130.31.120"},{"ipBegin":"10.130.31.104"},{"ipEnd":"10.130.31.104"}
etc...</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;compositLimits = []</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;for each(LINE in _ranges){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;limit = new Properties</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;limit.ipBegin = LINE.ipBegin</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;compositLimits.push(limit)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;limit = new Properties</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;limit.ipEnd = LINE.ipEnd</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;compositLimits.push(limit)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;} <span style="color: rgb(153, 153, 153);">// ; System.debug("compositLimits\n"+JSON.stringify(compositLimits).replace(/,/g,"\n"))</span></span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp; &nbsp;// 2) Trie de cette liste sur les valeur d'IP sans tenir compte de la clé (ipBegin ou ipEnd)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;sortedCompositLimits = compositLimits.sort(sortByIp) ;
System.debug("sortedCompositLimits\n"+JSON.stringify(sortedCompositLimits).replace(/,/g,"\n"))</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">// 3) Reduction overlap. &nbsp;</span></span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp;
&nbsp;//&nbsp;&nbsp;&nbsp; Posons que:&nbsp;&nbsp;&nbsp;&nbsp;
"["&nbsp; repr�sente "ipBegin"&nbsp;&nbsp;&nbsp; et
que&nbsp;&nbsp;&nbsp;&nbsp; "]"&nbsp; repr�sente&nbsp; "ipEnd". &nbsp;</span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp;&nbsp; Avant reduction:</span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp;&nbsp; [.....[.]....]......[.][....[.[.].]...]</span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp;&nbsp; Après reduction:</span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp; &nbsp;//&nbsp;&nbsp;&nbsp; [............]......[.][..............]</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;reduced = []</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;count = 0</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;bascul = true</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;for each(borne in sortedCompositLimits){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(borne.ipBegin){ count ++ }<span style="color: rgb(153, 153, 153);">//; System.debug("count = "+count) }</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(borne.ipEnd){ count -- }<span style="color: rgb(153, 153, 153);">//; System.debug("count = "+count) }</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;if(count == 1 &amp;&amp; bascul){ bascul =
!bascul ; reduced.push(borne) }<span style="color: rgb(153, 153, 153);">//; System.debug("push
"+JSON.stringify(borne)) }</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;if(count == 0 &amp;&amp; !bascul){ bascul =
!bascul ; reduced.push(borne) }<span style="color: rgb(153, 153, 153);">//; System.debug("push
"+JSON.stringify(borne)) }</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;System.debug("Exclusion RANGES (Après reduction
overlapp):"+JSON.stringify(reduced).replace(/."ipBegin"/g,"\n{ipBegin\""))</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">//
4)&nbsp; transformation de l'objet "reduced" en une suite de nombres
repr�sentants les IP: [ 1 , 2 , 3 , 4 ]&nbsp;&nbsp; -(Grace � la
fonction ipLong)</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;IPLongList = []</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;for each(borne in reduced){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;key = Object.keys(borne)[0]</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;IPLongList.push(ip2long(borne[key]))</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">//System.debug("Long ranges\n"+JSON.stringify(IPLongList).replace(/,/g,"\n"))</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;return IPLongList</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas;"><span style="color: rgb(153, 153, 153);">//
Fonction transformant, au sein d'un un pool d�limit� par ipLongBegin et
ipLongEnd, des Ranges constitu�s par une suite d'ipLongs repr�sentant
des intervals se suivants sans se recouvrir, </span></span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// en un json definissant des intervals oppos�s de type {"ipBegin":"10.130.31.100","ipEnd":"10.130.31.105"}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">function translateIntervalInRange(ipLongBegin,ipLongEnd,ArrayOfIpLong){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">// Partant de "ArrayOfIpLong" Exemple [1 , 2 , 3 , 4] On y ajoute le "ipLongBegin" 0 au debut, et le "ipLongEnd" 5 � la fin:</span></span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp; &nbsp;// R�sultat:&nbsp; [0 , 1 , 2 , 3 , 4 , 5]</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;ArrayOfIpLong.unshift(ipLongBegin)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;ArrayOfIpLong.push(ipLongEnd) <span style="color: rgb(153, 153, 153);">//System.debug("Long ranges in
scope\n"+JSON.stringify(ArrayOfIpLong).replace(/,/g,"\n"))</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">// Ensuite, notre tableau [0 , 1 , 2 , 3 , 4 , 5] ( soit [0[1-2][3-4]5] ) va donner [0 , 0 , 5 , 5] ( soit [0-0][5-5] )</span></span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp; &nbsp;// c'est à dire: 2 IP disponibles: 0 et 5</span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp;
&nbsp;// Mais la fonction est reversibe et [0 , 0 , 5 , 5] va donner [0
, 1 , 4 , 5] soit [0[1-4]5] une forme optimis� de [0[1-2][3-4]5]</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;nbAvailableIP = 0</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;bascul = false</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;resultArray = []</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;line = new Properties</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;for (I = 0 ; I &lt; ArrayOfIpLong.length ; I++){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;bascul = (!bascul)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;value = ArrayOfIpLong[I]</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(I == 0){ <span style="color: rgb(153, 153, 153);">// Si indice = 0, c'est l'ip de debut du pool </span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;line.ipBegin = value <span style="color: rgb(153, 153, 153);">// 1er ip de debut du premier interval autoris�</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}else{ </span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(I == ArrayOfIpLong.length - 1){ <span style="color: rgb(153, 153, 153);">// Si c'est l'IP de fin du dernier interval interdit </span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;line.ipEnd = value <span style="color: rgb(153, 153, 153);">// L'IP suivante sera l'IP de fin du dernier interval autoris�&nbsp; (La derni�re), celle de la fin du pool</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(line.ipBegin &lt;= line.ipEnd){ <span style="color: rgb(153, 153, 153);">// Si il y a plus d'une IP dans ce dernier interval </span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;nbAvailableIP += (line.ipEnd - line.ipBegin +
1) <span style="color: rgb(153, 153, 153);">// MAJ du Compteur d'IP</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;System.debug("Add oposit range
["+long2ip(line.ipBegin)+" - "+long2ip(line.ipEnd)+"]") <span style="color: rgb(153, 153, 153);">// debug</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;resultArray.push(line) ; line = new Properties
<span style="color: rgb(153, 153, 153);">// ajout de ce dernier intervall dans le json</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}else{ <span style="color: rgb(153, 153, 153);">// il s'agit de l'IP de debut ou de fin d'un des interval interdit</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(bascul){ <span style="color: rgb(153, 153, 153);">// Ici c'est l'ip de fin d'un interval interdit</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;line.ipBegin = value + 1 <span style="color: rgb(153, 153, 153);">// Donc l'ip suivante est l'ip de debut d'un interval autoris�</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}else{ <span style="color: rgb(153, 153, 153);">// Ici c'est l'ip de debut d'un interval interdit</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;line.ipEnd = value - 1 <span style="color: rgb(153, 153, 153);">// Donc l'ip pr�c�dente est l'ip de fin d'un interval autoris�</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;if(line.ipBegin &lt;= line.ipEnd){ <span style="color: rgb(153, 153, 153);">// Si il y a plus d'une IP dans ce dernier interval </span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;nbAvailableIP +=
(line.ipEnd - line.ipBegin + 1) <span style="color: rgb(153, 153, 153);">// MAJ du Compteur d'IP</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;System.debug("Add oposit
range ["+long2ip(line.ipBegin)+" - "+long2ip(line.ipEnd)+"]") <span style="color: rgb(153, 153, 153);">// debug</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;resultArray.push(line) ;
line = new Properties <span style="color: rgb(153, 153, 153);">// ajout ce dernier intervall dans le json</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">//System.warn("nbAvailableIP = "+nbAvailableIP)</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;System.debug("translated = "+JSON.stringify(resultArray))</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;return resultArray</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas;">function sortByIp(a,b){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">//diff = ip2long(a.ipBegin) - ip2long(b.ipBegin)</span></span><br style="font-family: Consolas; color: rgb(153, 153, 153);"><span style="font-family: Consolas; color: rgb(153, 153, 153);">&nbsp;&nbsp; &nbsp;//System.debug("diff = "+diff)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;A = a.ipBegin ; if(!A){ A = a.ipEnd }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;B = b.ipBegin ; if(!B){ B = b.ipEnd }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;diff = ip2long(A) - ip2long(B)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(diff &gt; 0){ return 1 }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(diff &lt; 0){ return -1 }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(diff == 0){ return 0 }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// V�rifie la validit� d'un range dans un autre range (_scope est un composite)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">function chkRangeInScope(_scope,_hostMin,_hostMax,debug){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;errListLimits = [] <span style="color: rgb(153, 153, 153);">// sortie en failed</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">// verif interval positif</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(ip2long(_scope.ipBegin) &gt; ip2long(_scope.ipEnd)){ </span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;errListLimits.push("ipBegin
("+_scope.ipBegin+") must be lower than ipEnd ("+_scope.ipEnd+")")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">// verif address de debut dans l'intervalle</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;result = chkIpforLimits(_scope.ipBegin,_hostMin,_hostMax)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(result != "succeed"){ <span style="color: rgb(153, 153, 153);">// Failed</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;errListLimits.push(result) </span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">// verif address de fin dans l'intervalle</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;result = chkIpforLimits(_scope.ipEnd,_hostMin,_hostMax)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(result != "succeed"){ <span style="color: rgb(153, 153, 153);">// Failed</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;errListLimits.push(result) </span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">// L'heure du bilan:</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(errListLimits.length &gt; 0){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;System.warn("chkRangeInScope(): failed")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return errListLimits.join(", ") <span style="color: rgb(153, 153, 153);">//Failed: return error (string)</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;} else {</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;if(debug){ System.debug("chkRangeInScope():
["+_scope.ipBegin+" - "+_scope.ipEnd+"] is included in ["+_hostMin+" -
"+_hostMax+"]") }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return "succeed"</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><br style="font-family: Consolas;"><span style="font-family: Consolas; color: rgb(153, 153, 153);">// Vérifie qu'une ip est bien entre deux ipMin et ipMax</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">function chkIpforLimits(ip,ipMin,ipMax){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;ER = [] ; var myURL = new URL()</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;if(!myURL.isValidIPv4Address(ip)){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return "ip \""+ip+"\": Invalid IPv4 addr"</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}else{</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ipLong = ip2long(ip) ; ipMinLong = ip2long(ipMin) ; ipMaxLong = ip2long(ipMax)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span style="color: rgb(153, 153, 153);">//System.debug(ip+"="+ipLong+"&nbsp; "+ipMin+" = "+ipMinLong+"&nbsp; "+ipMax+" = "+ipMaxLong+"&nbsp; "+typeof(ipLong))</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(ipLong &lt; ipMinLong){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ER.push("ipBegin "+ip+" must be equal or higher than "+ipMin)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(ipLong &gt; ipMaxLong){</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ER.push("ipEnd "+ip+" must be equal or lower than "+ipMax)</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(ER.length &gt; 0){ <span style="color: rgb(153, 153, 153);">// Failed</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;System.error(ER.join(", "))</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return ER.join(", ")</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;} else { <span style="color: rgb(153, 153, 153);">// Success</span></span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return "succeed"</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp; &nbsp;}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">function long2ip(l) {</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp; with (Math) {</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var ip1 = floor(l/pow(256,3));</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var ip2 = floor((l%pow(256,3))/pow(256,2));</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var ip3 = floor(((l%pow(256,3))%pow(256,2))/pow(256,1));</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var ip4 = floor((((l%pow(256,3))%pow(256,2))%pow(256,1))/pow(256,0));</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp; }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp; return ip1 + '.' + ip2 + '.' + ip3 + '.' + ip4;</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">}</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">function ip2long(_ip) {</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp; var ips = _ip.split('.');</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp; var _iplong = 0;</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp; with (Math) {</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _iplong = ips[0]*pow(256,3)+ips[1]*pow(256,2)+ips[2]*pow(256,1)+ips[3]*pow(256,0);</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp; }</span><br style="font-family: Consolas;"><span style="font-family: Consolas;">&nbsp;&nbsp;&nbsp; return _iplong;</span><br style="fon